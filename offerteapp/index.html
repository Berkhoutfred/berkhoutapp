<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berkhout Totaal Systeem</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAi1U8gP0dlE87sYaUDI2JbKKFxJW_YjlY&libraries=places"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #004a99;
            --secondary: #003366;
            --accent: #28a745;
            --bg: #f4f6f9;
            --sidebar-width: 250px;
            --text-dark: #333;
        }

        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text-dark); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .logo { font-size: 20px; font-weight: 900; margin-bottom: 40px; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; font-size: 15px; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.2); font-weight: bold; }
        .sidebar-footer { margin-top: auto; font-size: 11px; opacity: 0.6; text-align: center; }

        /* MAIN */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: bold; color: var(--secondary); }

        /* COMPONENTS */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e0e0e0; }
        .section-header { font-size: 16px; font-weight: bold; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }

        label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; box-sizing: border-box; margin-bottom: 10px; }
        input:focus { border-color: var(--primary); outline: none; }
        
        .time-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 8px; background: #f9f9fc; border-radius: 6px; border: 1px solid #eee; }
        .time-label { width: 140px; font-weight: 600; font-size: 13px; }

        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: #dc3545; color: white; }
        
        /* TABELLEN & STATUS */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        th { color: #888; font-weight: 600; font-size: 12px; text-transform: uppercase; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .status-offerte { background: #e3f2fd; color: #1976d2; }
        .status-opdracht { background: #e8f5e9; color: #2e7d32; }

        /* SECTIONS */
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .total-block { background: #eef6ff; border: 2px solid var(--primary); padding: 20px; text-align: right; border-radius: 8px; margin-top: 20px; }
        .total-price { font-size: 32px; font-weight: 900; color: var(--primary); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fa-solid fa-bus"></i> BERKHOUT</div>
        <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-chart-line"></i> Dashboard</div>
        <div class="nav-item" onclick="nav('nieuwe-rit')"><i class="fa-solid fa-calculator"></i> Calculatie / Offerte</div>
        <div class="nav-item" onclick="nav('klanten')"><i class="fa-solid fa-users"></i> Klantenbestand</div>
        <div class="nav-item" onclick="nav('planning')"><i class="fa-solid fa-calendar-days"></i> Planning</div>
        
        <div class="sidebar-footer">v1.2 - Berkhout Touringcars</div>
    </div>

    <div class="main">
        
        <div id="dashboard" class="page-section active">
            <div class="header"><div class="page-title">Overzicht</div><button class="btn btn-primary" onclick="nav('nieuwe-rit')">+ Nieuwe Calculatie</button></div>
            <div class="grid-3">
                <div class="card"><div style="font-size:30px; font-weight:bold; color:var(--primary)" id="count-offertes">0</div><div>Openstaande Offertes</div></div>
                <div class="card"><div style="font-size:30px; font-weight:bold; color:var(--accent)" id="count-opdrachten">0</div><div>Bevestigde Ritten</div></div>
                <div class="card"><div style="font-size:30px; font-weight:bold; color:#666" id="count-klanten">0</div><div>Klanten</div></div>
            </div>
            <div class="card">
                <div class="section-header">Recente Ritten</div>
                <table id="recent-table">
                    <thead><tr><th>Datum</th><th>Klant</th><th>Bestemming</th><th>Bedrag</th><th>Status</th><th>Actie</th></tr></thead>
                    <tbody id="recent-body"></tbody>
                </table>
            </div>
        </div>

        <div id="nieuwe-rit" class="page-section">
            <div class="header"><div class="page-title">Calculatie & Offerte</div></div>
            <div class="grid-2">
                <div>
                    <div class="card">
                        <div class="section-header">1. Klant & Route</div>
                        <label>Selecteer Klant</label>
                        <select id="calc-klant-select" onchange="vulKlantInCalc()"><option value="">-- Kies Klant --</option></select>
                        <label style="margin-top:10px;">Vertrek (Garage)</label>
                        <input type="text" id="route-start" value="Industrieweg 99J, Zutphen">
                        <label>Bestemming</label>
                        <input type="text" id="route-eind" placeholder="Typ bestemming..." onchange="berekenGoogleAfstand()">
                        <div style="background:#f0f7ff; padding:10px; border-radius:6px; font-weight:bold; color:var(--primary); text-align:center;">
                            Retour: <span id="display-km-retour">0</span> km
                        </div>
                        <input type="hidden" id="val-km-retour" value="0">
                    </div>
                </div>

                <div>
                    <div class="card">
                        <div class="section-header">2. Tijdschema</div>
                        <div class="time-row"><div class="time-label">1. Vertrek Zaak</div><input type="time" id="t-vertrek-zaak" value="08:00" onchange="rekenUren()"></div>
                        <div class="time-row"><div class="time-label">2. Voorstaan</div><input type="time" id="t-voorstaan" value="08:30" onchange="rekenUren()"></div>
                        <div class="time-row"><div class="time-label">3. Vertrek Klant</div><input type="time" id="t-vertrek-klant" value="08:45" onchange="rekenUren()"></div>
                        <div class="time-row"><div class="time-label">4. Aankomst Loc.</div><input type="time" id="t-aankomst-loc" value="10:00" onchange="rekenUren()"></div>
                        <div style="text-align:center; font-size:11px; color:#888;">-- Verblijf --</div>
                        <div class="time-row"><div class="time-label">5. Vertrek Loc.</div><input type="time" id="t-vertrek-loc" value="16:00" onchange="rekenUren()"></div>
                        <div class="time-row"><div class="time-label">6. Retour Klant</div><input type="time" id="t-retour-klant" value="17:15" onchange="rekenUren()"></div>
                        <div class="time-row"><div class="time-label">7. Aankomst Zaak</div><input type="time" id="t-aankomst-zaak" value="17:45" onchange="rekenUren()"></div>
                        <div style="font-weight:bold; text-align:right; margin-top:5px;">Totaal Uren: <span id="display-uren">0.0</span></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="section-header">3. Financieel</div>
                <div class="grid-2">
                    <div>
                        <label>Overige kosten (Tol/Parkeren)</label>
                        <input type="number" id="kosten-overig" value="0" oninput="rekenPrijs()">
                    </div>
                    <div class="total-block">
                        <div style="font-size:12px; color:#666;">Offertebedrag (incl. 9% BTW)</div>
                        <div class="total-price" id="eind-totaal">€ 0,00</div>
                        <div style="font-size:11px; color:#28a745;">Afgerond op € 25,- (Winstmarge ~33%)</div>
                    </div>
                </div>
                <button class="btn btn-primary" style="width:100%; justify-content:center; margin-top:15px;" onclick="slaRitOp()"><i class="fa-solid fa-save"></i> Opslaan als Offerte</button>
            </div>
        </div>

        <div id="klanten" class="page-section">
            <div class="header">
                <div class="page-title">Klantenbestand</div>
                <button class="btn btn-success" onclick="toggleNieuweKlant()">+ Nieuwe Klant</button>
            </div>
            
            <div id="nieuw-klant-form" class="card" style="display:none; background:#f0f7ff; border:2px solid var(--primary);">
                <div class="section-header">Nieuwe Klant / Bedrijf Zoeken</div>
                
                <label style="color:var(--primary);"><i class="fa-solid fa-magnifying-glass"></i> Zoek Bedrijf op Google (Naam + Adres vult automatisch)</label>
                <input type="text" id="google-bedrijf-zoek" placeholder="Typ bedrijfsnaam (bijv. 'Bakker Bart Zutphen')..." style="border:2px solid var(--primary);">

                <div class="grid-2" style="margin-top:15px;">
                    <div>
                        <label>Naam / Bedrijf</label>
                        <input type="text" id="nk-naam">
                        <label>Contactpersoon</label>
                        <input type="text" id="nk-contact">
                        <label>E-mailadres</label>
                        <input type="email" id="nk-email">
                    </div>
                    <div>
                        <label>Adres (Straat + Huisnr)</label>
                        <input type="text" id="nk-adres">
                        <label>Postcode & Plaats</label>
                        <input type="text" id="nk-plaats">
                        <label>Telefoon</label>
                        <input type="text" id="nk-tel">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="slaKlantOp()">Opslaan</button>
                <button class="btn btn-danger" onclick="toggleNieuweKlant()">Annuleren</button>
            </div>

            <div class="card">
                <table id="klanten-tabel">
                    <thead><tr><th>Naam</th><th>Plaats</th><th>Email</th><th>Actie</th></tr></thead>
                    <tbody id="klanten-body"></tbody>
                </table>
            </div>
        </div>

        <div id="planning" class="page-section">
            <div class="header"><div class="page-title">Planning</div></div>
            <div class="card" style="text-align:center; padding:50px;">
                <h3 style="color:#666;">Planning module in ontwikkeling</h3>
                <p>Hier komt het grafische planbord.</p>
            </div>
        </div>

    </div>

    <script>
        // DATA
        let db = { klanten: [], ritten: [] };

        // INIT
        function initApp() {
            const opgeslagen = localStorage.getItem('berkhout_erp_v1');
            if(opgeslagen) db = JSON.parse(opgeslagen);
            updateDashboard();
            vulKlantenLijst();
            initGoogleMaps();
            rekenUren();
        }

        function saveData() {
            localStorage.setItem('berkhout_erp_v1', JSON.stringify(db));
            updateDashboard();
            vulKlantenLijst();
        }

        function nav(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // GOOGLE MAPS & AUTOCOMPLETE
        function initGoogleMaps() {
            const options = { types: ['address'], componentRestrictions: {country: 'nl'} };
            
            // Route velden
            new google.maps.places.Autocomplete(document.getElementById('route-start'), options);
            const autoEind = new google.maps.places.Autocomplete(document.getElementById('route-eind'), options);
            autoEind.addListener('place_changed', berekenGoogleAfstand);

            // Klant Adres Zoeken (Alleen adres)
            const autoAdres = new google.maps.places.Autocomplete(document.getElementById('nk-adres'), options);
            autoAdres.addListener('place_changed', () => {
                const place = autoAdres.getPlace();
                fillAddressFields(place);
            });

            // Bedrijven Zoeker (Establishment)
            const bedrijfOptions = { types: ['establishment'], componentRestrictions: {country: 'nl'} };
            const autoBedrijf = new google.maps.places.Autocomplete(document.getElementById('google-bedrijf-zoek'), bedrijfOptions);
            
            autoBedrijf.addListener('place_changed', () => {
                const place = autoBedrijf.getPlace();
                document.getElementById('nk-naam').value = place.name || '';
                document.getElementById('nk-tel').value = place.formatted_phone_number || '';
                fillAddressFields(place);
            });
        }

        function fillAddressFields(place) {
            let straat = '', huisnr = '', postcode = '', stad = '';
            if (place.address_components) {
                for (const component of place.address_components) {
                    const type = component.types[0];
                    if (type === "route") straat = component.long_name;
                    if (type === "street_number") huisnr = component.long_name;
                    if (type === "postal_code") postcode = component.long_name;
                    if (type === "locality") stad = component.long_name;
                }
            }
            document.getElementById('nk-adres').value = `${straat} ${huisnr}`.trim();
            document.getElementById('nk-plaats').value = `${postcode} ${stad}`.trim();
        }

        function berekenGoogleAfstand() {
            const start = document.getElementById('route-start').value;
            const eind = document.getElementById('route-eind').value;
            if(!start || !eind) return;

            const service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({ origins: [start], destinations: [eind], travelMode: 'DRIVING' }, (response, status) => {
                if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                    const dist = response.rows[0].elements[0].distance.value / 1000;
                    const retour = Math.round(dist * 2);
                    document.getElementById('display-km-retour').innerText = retour;
                    document.getElementById('val-km-retour').value = retour;
                    rekenPrijs();
                }
            });
        }

        // KLANTEN
        function toggleNieuweKlant() {
            const el = document.getElementById('nieuw-klant-form');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function slaKlantOp() {
            const naam = document.getElementById('nk-naam').value;
            if(!naam) return alert("Naam is verplicht");
            
            db.klanten.push({
                id: Date.now(),
                naam: naam,
                contact: document.getElementById('nk-contact').value,
                email: document.getElementById('nk-email').value,
                adres: document.getElementById('nk-adres').value,
                plaats: document.getElementById('nk-plaats').value
            });
            saveData();
            toggleNieuweKlant();
            document.getElementById('nk-naam').value = ''; 
            document.getElementById('google-bedrijf-zoek').value = '';
        }

        function vulKlantenLijst() {
            const tbody = document.getElementById('klanten-body');
            tbody.innerHTML = '';
            db.klanten.forEach(k => {
                tbody.innerHTML += `<tr><td><b>${k.naam}</b></td><td>${k.plaats}</td><td>${k.email}</td><td><button class="btn btn-primary" style="padding:4px 8px; font-size:12px;" onclick="kiesKlant('${k.id}')">Kies</button></td></tr>`;
            });
            const select = document.getElementById('calc-klant-select');
            select.innerHTML = '<option value="">-- Kies Klant --</option>';
            db.klanten.forEach(k => { select.innerHTML += `<option value="${k.id}">${k.naam}</option>`; });
        }

        function kiesKlant(id) {
            nav('nieuwe-rit');
            document.getElementById('calc-klant-select').value = id;
            vulKlantInCalc();
        }

        function vulKlantInCalc() {
            // Placeholder logic indien nodig
        }

        // REKENMACHINE
        function rekenUren() {
            const tStart = parseTime(document.getElementById('t-vertrek-zaak').value);
            const tEind = parseTime(document.getElementById('t-aankomst-zaak').value);
            if(tStart && tEind) {
                let diff = (tEind - tStart) / (1000 * 60 * 60);
                if(diff < 0) diff += 24;
                document.getElementById('display-uren').innerText = diff.toFixed(2);
                rekenPrijs();
            }
        }

        function parseTime(t) {
            if(!t) return null;
            const [h, m] = t.split(':');
            const d = new Date(); d.setHours(h, m, 0);
            return d;
        }

        function rekenPrijs() {
            const uren = parseFloat(document.getElementById('display-uren').innerText) || 0;
            const kms = parseFloat(document.getElementById('val-km-retour').value) || 0;
            const extra = parseFloat(document.getElementById('kosten-overig').value) || 0;

            const tariefKm = 1.00;
            const tariefUur = 33.00;
            
            let kostprijs = (kms * tariefKm) + (uren * tariefUur) + extra;
            
            // Winstmarge ~33% op verkoopprijs (Factor 1.5)
            let verkoopEx = kostprijs * 1.5;
            let totaalIncl = verkoopEx * 1.09;

            // Afronden op 25 euro
            // Math.ceil zorgt dat je altijd naar boven afrond naar volgende 25-tal voor veiligheid?
            // Of Math.round voor dichtstbijzijnde. Laten we 'nearest' doen.
            totaalIncl = Math.round(totaalIncl / 25) * 25;

            // Minimaal 200
            if(totaalIncl < 200) totaalIncl = 200;

            document.getElementById('eind-totaal').innerText = '€ ' + totaalIncl.toLocaleString('nl-NL', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function slaRitOp() {
            const klantId = document.getElementById('calc-klant-select').value;
            const klantNaam = klantId ? db.klanten.find(k=>k.id==klantId).naam : 'Onbekend';
            
            db.ritten.unshift({
                id: Date.now(),
                datum: new Date().toLocaleDateString(),
                klant: klantNaam,
                bestemming: document.getElementById('route-eind').value,
                bedrag: document.getElementById('eind-totaal').innerText,
                status: 'Offerte'
            });
            saveData();
            nav('dashboard');
        }

        function updateDashboard() {
            document.getElementById('count-klanten').innerText = db.klanten.length;
            document.getElementById('count-offertes').innerText = db.ritten.filter(r => r.status === 'Offerte').length;
            document.getElementById('count-opdrachten').innerText = db.ritten.filter(r => r.status === 'Opdracht').length;
            
            const tbody = document.getElementById('recent-body');
            tbody.innerHTML = '';
            db.ritten.slice(0, 5).forEach(r => {
                tbody.innerHTML += `<tr><td>${r.datum}</td><td><b>${r.klant}</b></td><td>${r.bestemming}</td><td>${r.bedrag}</td><td><span class="status-badge status-${r.status.toLowerCase()}">${r.status}</span></td><td><button class="btn btn-primary" style="padding:4px;" onclick="window.location.href='mailto:?subject=Offerte&body=Bedrag: ${r.bedrag}'"><i class="fa-solid fa-envelope"></i></button></td></tr>`;
            });
        }

        window.onload = initApp;
    </script>
</body>
</html>
