<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berkhout Planning V3.26 (Hardcore Mode)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAi1U8gP0dlE87sYaUDI2JbKKFxJW_YjlY&libraries=places&callback=initApp" async defer></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #f3f4f6; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 240px; background: #004a99; color: white; padding: 20px; display: flex; flex-direction: column; }
        .nav-item { padding: 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-item:hover { background: rgba(255,255,255,0.2); }
        .nav-item.active { background: white; color: #004a99; font-weight: bold; }
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        
        /* Simpele Layout */
        .page-section { display: none; } /* Standaard verborgen */
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Inputs & Tables */
        input, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .rit-table { width: 100%; border-collapse: collapse; background: white; }
        .rit-table th, .rit-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; width: 100%; margin-top: 10px; }
        .btn-green { background: #10b981; }
        .btn-blue { background: #004a99; }
        .btn-red { background: #ef4444; margin-top: auto; text-align: center; }
        .action-btn { background: #eee; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: 1px solid #ccc; }

        /* Helpers */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="font-size:20px; font-weight:bold; margin-bottom:30px;">BERKHOUT REIZEN</div>
    <div class="nav-item" onclick="nav('dashboard')">1. Planning</div>
    <div class="nav-item" onclick="nav('calculatie')">2. Nieuwe Rit</div>
    <div class="nav-item" onclick="nav('klanten')">3. Klanten</div>
    <div class="nav-item btn-red" onclick="hardReset()">⚠️ RESET SYSTEEM</div>
</div>

<div class="main">

    <div id="dashboard" class="page-section" style="display:block;">
        <h2>Planning Dashboard</h2>
        <div class="card">
            <table class="rit-table">
                <thead><tr><th>Datum</th><th>Klant</th><th>Bestemming</th><th>Prijs</th><th>Status</th></tr></thead>
                <tbody id="rit-tabel-body"></tbody>
            </table>
            <div id="empty-state" style="padding:20px; text-align:center; color:#999;">Geen ritten gevonden.</div>
        </div>
    </div>

    <div id="calculatie" class="page-section">
        <h2>Nieuwe Offerte</h2>
        <div class="grid-2">
            <div class="card">
                <h3>1. Klant & Datum</h3>
                <label>Startdatum</label><input type="date" id="rit_datum" onchange="syncDates()">
                <div id="display-start-date" style="color:grey; font-size:12px; margin-bottom:10px;"></div>
                
                <label>Einddatum</label><input type="date" id="rit_datum_eind" onchange="rekenUren()">
                <div id="display-end-date" style="color:grey; font-size:12px; margin-bottom:10px;"></div>

                <label>Zoek Klant</label>
                <select id="calc-klant-select" onchange="selectCalcClient(this.value)">
                    <option value="">-- Typ of kies klant --</option>
                </select>
                
                <label>Contactpersoon</label><select id="calc-contact"></select>
                <label>Aantal Personen</label><input type="number" id="calc-pax">
                
                <h3>2. Route</h3>
                <label>Vertrek</label><input type="text" id="route-start" value="Industrieweg 99J, Zutphen">
                <label>Ophaal</label><input type="text" id="route-ophaal" onchange="berekenRoute()">
                <label>Bestemming</label><input type="text" id="route-eind" onchange="berekenRoute()">
                <div style="background:#eef; padding:10px;">
                    Info: <span id="info-aanrij">-</span> | <span id="info-rit">-</span> | <span id="info-totaal">0 km</span>
                </div>
            </div>
            
            <div class="card">
                <h3>3. Prijs & Winst</h3>
                <label>Variabele Kosten (Parkeren/Tol/Catering) - Excl BTW</label>
                <input type="number" id="cost-vars" placeholder="€ 0.00" oninput="rekenPrijs()">
                
                <label>Extra Winst (Excl BTW)</label>
                <input type="number" id="profit-correction" placeholder="€ 0.00" oninput="rekenPrijs()">
                
                <div style="background:#004a99; color:white; padding:20px; text-align:center; border-radius:8px;">
                    <div style="font-size:30px; font-weight:bold;" id="prijs-display">€ 0,00</div>
                    <div id="btw-display">BTW: € 0,00</div>
                </div>
                
                <div style="margin-top:10px; text-align:center; color:green; font-weight:bold;">
                    WINST (incl afronding): <span id="live-profit">€ 0</span>
                </div>

                <div style="margin-top:20px; border:1px solid #ddd; padding:10px;">
                    <label>Datums:</label>
                    Offerte: <input type="date" id="calc-date-offerte"><br>
                    Bevestigd: <input type="date" id="calc-date-bevestiging"><br>
                    Factuur: <input type="date" id="calc-date-factuur">
                </div>

                <button class="btn btn-green" onclick="opslaan()">RIT OPSLAAN</button>
            </div>
        </div>
    </div>

    <div id="klanten" class="page-section">
        <div id="crm-list-view">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Klantenbestand</h2>
                <button class="btn btn-blue" style="width:auto;" onclick="nieuwKlantScherm()">+ NIEUWE KLANT</button>
            </div>
            <div class="card">
                <input type="text" id="crm-search" placeholder="Zoek..." onkeyup="renderClientList()">
                <table class="rit-table"><tbody id="crm-table-body"></tbody></table>
            </div>
        </div>

        <div id="crm-detail-view" style="display:none;">
            <h2>Klant Bewerken/Maken</h2>
            <div class="card">
                <label>Naam (Verplicht)</label><input type="text" id="crm-naam">
                <label>Adres</label><input type="text" id="crm-adres">
                <label>Plaats</label><input type="text" id="crm-plaats">
                <label>Telefoon</label><input type="text" id="crm-tel">
                <label>Debiteurnummer</label><input type="text" id="crm-deb">
                
                <label>Contactpersoon Naam</label><input type="text" id="cp-naam">
                <label>Contactpersoon Email</label><input type="text" id="cp-email">
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-green" onclick="saveClient()">OPSLAAN</button>
                    <button class="btn btn-red" onclick="terugNaarLijst()" style="margin-top:10px;">ANNULEREN</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // GLOBAL DB
    window.db = { klanten: [], ritten: [] };
    let activeClientId = null;
    let activeRitId = null;

    // INIT
    window.initApp = function() {
        console.log("Start Init...");
        const s = localStorage.getItem('berkhout_v2');
        if(s) {
            try { window.db = JSON.parse(s); } catch(e) { console.log("DB Reset"); }
        }
        if(!window.db.klanten) window.db.klanten = [];
        if(!window.db.ritten) window.db.ritten = [];
        
        console.log("DB Ready", window.db);
        
        // Setup Date
        const t = new Date().toISOString().split('T')[0];
        const rd = document.getElementById('rit_datum');
        if(rd) { rd.value=t; document.getElementById('rit_datum_eind').value=t; }
        
        initMapsAutofill();
        renderClientList();
        updateDashboard();
        fillKlantSelect();
    };

    function hardReset() {
        if(confirm("Alles wissen?")) {
            localStorage.removeItem('berkhout_v2');
            location.reload();
        }
    }

    // --- NAVIGATIE (KEI HARD) ---
    function nav(id) {
        // Verberg alles
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('calculatie').style.display = 'none';
        document.getElementById('klanten').style.display = 'none';
        
        // Toon gekozen
        document.getElementById(id).style.display = 'block';
        
        // Update menu kleur
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // (Simpele hack: we weten de volgorde)
    }

    // --- CRM FUNCTIES (SUPER SIMPEL) ---
    function nieuwKlantScherm() {
        alert("Nieuw scherm openen...");
        activeClientId = null;
        document.getElementById('crm-naam').value = "";
        document.getElementById('crm-adres').value = "";
        document.getElementById('crm-plaats').value = "";
        document.getElementById('crm-tel').value = "";
        document.getElementById('crm-deb').value = "";
        document.getElementById('cp-naam').value = "";
        document.getElementById('cp-email').value = "";
        
        document.getElementById('crm-list-view').style.display = 'none';
        document.getElementById('crm-detail-view').style.display = 'block';
    }

    function editClient(id) {
        activeClientId = id;
        const k = window.db.klanten.find(x => x.id == id);
        if(k) {
            document.getElementById('crm-naam').value = k.naam;
            document.getElementById('crm-adres').value = k.adres;
            document.getElementById('crm-plaats').value = k.plaats;
            document.getElementById('crm-tel').value = k.tel;
            document.getElementById('crm-deb').value = k.debiteurnr;
            
            // Simpele CP support (1e cp)
            if(k.contactpersonen && k.contactpersonen[0]) {
                document.getElementById('cp-naam').value = k.contactpersonen[0].naam;
                document.getElementById('cp-email').value = k.contactpersonen[0].email;
            }
            
            document.getElementById('crm-list-view').style.display = 'none';
            document.getElementById('crm-detail-view').style.display = 'block';
        }
    }

    function saveClient() {
        alert("Bezig met opslaan...");
        const naam = document.getElementById('crm-naam').value;
        if(!naam) { alert("Vul een naam in!"); return; }

        const cp = {
            naam: document.getElementById('cp-naam').value,
            email: document.getElementById('cp-email').value
        };

        const data = {
            id: activeClientId || Date.now(),
            naam: naam,
            adres: document.getElementById('crm-adres').value,
            plaats: document.getElementById('crm-plaats').value,
            tel: document.getElementById('crm-tel').value,
            debiteurnr: document.getElementById('crm-deb').value,
            contactpersonen: [cp]
        };

        if(activeClientId) {
            const idx = window.db.klanten.findIndex(x => x.id == activeClientId);
            if(idx > -1) window.db.klanten[idx] = data;
        } else {
            window.db.klanten.push(data);
        }

        localStorage.setItem('berkhout_v2', JSON.stringify(window.db));
        alert("Klant opgeslagen!");
        
        renderClientList();
        fillKlantSelect();
        terugNaarLijst();
    }

    function terugNaarLijst() {
        document.getElementById('crm-detail-view').style.display = 'none';
        document.getElementById('crm-list-view').style.display = 'block';
    }

    function renderClientList() {
        const tbody = document.getElementById('crm-table-body');
        tbody.innerHTML = '';
        window.db.klanten.forEach(k => {
            let tr = `<tr>
                <td><b>${k.naam}</b></td>
                <td>${k.plaats}</td>
                <td>${k.contactpersonen[0]?.email || ''}</td>
                <td>
                    <button class="action-btn" onclick="editClient(${k.id})">✏️</button>
                </td>
            </tr>`;
            tbody.innerHTML += tr;
        });
    }

    // --- CALCULATIE & DATE DISPLAY ---
    function fillKlantSelect() {
        const s = document.getElementById('calc-klant-select');
        s.innerHTML = '<option value="">-- Kies Klant --</option>';
        window.db.klanten.forEach(k => {
            s.innerHTML += `<option value="${k.id}">${k.naam} (${k.plaats})</option>`;
        });
    }

    function selectCalcClient(id) {
        const k = window.db.klanten.find(x => x.id == id);
        if(k) {
            document.getElementById('route-ophaal').value = k.adres;
            document.getElementById('calc-contact').innerHTML = `<option>${k.contactpersonen[0]?.naam || 'Geen CP'}</option>`;
        }
    }

    function syncDates() {
        const v = document.getElementById('rit_datum').value;
        document.getElementById('rit_datum_eind').value = v;
        updateDateText();
    }

    function updateDateText() {
        const d1 = document.getElementById('rit_datum').value;
        const d2 = document.getElementById('rit_datum_eind').value;
        const opt = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        
        if(d1) document.getElementById('display-start-date').innerText = new Date(d1).toLocaleDateString('nl-NL', opt);
        if(d2) document.getElementById('display-end-date').innerText = new Date(d2).toLocaleDateString('nl-NL', opt);
    }

    function rekenPrijs() {
        // Dummy berekening voor test - Pas aan met echte logica
        // Maar eerst zorgen dat opslaan werkt!
        const vars = parseFloat(document.getElementById('cost-vars').value) || 0;
        const profit = parseFloat(document.getElementById('profit-correction').value) || 0;
        const base = 250; // Dummy base
        
        let totalEx = base + vars + profit;
        let totalIncl = totalEx * 1.09;
        
        // Afronden
        let final = Math.ceil(totalIncl / 25) * 25;
        let btw = final - (final / 1.09);
        let realProfit = (final/1.09) - (base + vars);

        document.getElementById('prijs-display').innerText = '€ ' + final.toLocaleString('nl-NL');
        document.getElementById('btw-display').innerText = 'BTW: € ' + btw.toFixed(2);
        document.getElementById('live-profit').innerText = '€ ' + realProfit.toFixed(0);
    }

    // GOOGLE MAPS DUMMY (ALS API KEY FAALT WERKT DE REST NOG WEL)
    function initMapsAutofill() {
        console.log("Maps init (of poging tot)");
        // Hier zou de autocomplete logica staan
        // We laten hem even leeg om JS errors te voorkomen als de key fout is
    }
    function berekenRoute() {
        console.log("Route berekenen...");
        // Dummy values om te testen
        document.getElementById('info-totaal').innerText = "100 km";
        rekenPrijs();
    }
    
    function rekenUren() { updateDateText(); }

    function opslaan() {
        alert("Rit opslaan... (logica komt na CRM fix)");
        const rit = {
            datum: document.getElementById('rit_datum').value,
            klant: "Test Rit",
            bestemming: document.getElementById('route-eind').value,
            prijs: document.getElementById('prijs-display').innerText,
            status: {offerte:true}
        };
        window.db.ritten.push(rit);
        localStorage.setItem('berkhout_v2', JSON.stringify(window.db));
        updateDashboard();
        nav('dashboard');
    }

    function updateDashboard() {
        const b = document.getElementById('rit-tabel-body');
        b.innerHTML = '';
        if(window.db.ritten.length === 0) {
            document.getElementById('empty-state').style.display = 'block';
        } else {
            document.getElementById('empty-state').style.display = 'none';
            window.db.ritten.forEach(r => {
                b.innerHTML += `<tr><td>${r.datum}</td><td>${r.klant}</td><td>${r.bestemming}</td><td>${r.prijs}</td><td>OK</td></tr>`;
            });
        }
    }

</script>
</body>
</html>
