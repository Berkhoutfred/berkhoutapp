<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berkhout Planning V3.17 (Live Winst & PDF)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAi1U8gP0dlE87sYaUDI2JbKKFxJW_YjlY&libraries=places&callback=initApp" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #004a99; --bg: #f3f4f6; --text: #1f2937; --border: #e5e7eb; --success: #10b981; --grey: #d1d5db; --warning: #f59e0b; --danger: #ef4444; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* LAYOUT */
        .sidebar { width: 240px; background: var(--primary); color: white; padding: 25px; display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0,0,0,0.1); z-index: 10; }
        .brand { font-size: 22px; font-weight: 800; margin-bottom: 40px; }
        .nav-item { padding: 14px; cursor: pointer; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-weight: 500; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: white; color: var(--primary); font-weight: 700; }
        
        .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        .page-section { display: none; max-width: 1400px; margin: 0 auto; }
        .page-section.active { display: block; animation: fadeIn 0.3s ease; }
        
        /* COMPONENTS */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid var(--border); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        h2 { color: var(--primary); border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 25px; }
        h3 { font-size: 16px; color: var(--primary); margin: 20px 0 10px 0; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        
        /* FORMS */
        label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 6px; margin-top: 15px; }
        label:first-of-type { margin-top: 0; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: transparent; }
        
        /* DASHBOARD */
        .filter-bar { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; }
        .year-selector { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 15px; font-size: 24px; font-weight: 800; color: var(--primary); }
        .month-grid { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .month-btn { padding: 8px 16px; border: 1px solid #e5e7eb; background: #fff; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600; color: #6b7280; transition: 0.2s; }
        .month-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* TABLES */
        .rit-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .rit-table th { text-align: left; padding: 12px 10px; background: #f9fafb; border-bottom: 2px solid #e5e7eb; color: #6b7280; font-weight: 700; text-transform: uppercase; font-size: 11px; }
        .rit-table td { padding: 12px 10px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .rit-table tr:hover { background: #f0f9ff; }
        .tag { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; display: inline-block; }
        .tag-blue { background: #dbeafe; color: #1e40af; } 
        .tag-purple { background: #f3e8ff; color: #6b21a8; } 
        .tag-orange { background: #ffedd5; color: #9a3412; }
        
        /* STATUS ICONS */
        .status-cell { text-align: center; cursor: pointer; }
        .status-icon { font-size: 16px; color: #e5e7eb; transition: 0.2s; }
        .status-icon:hover { transform: scale(1.2); color: #d1d5db; }
        .status-icon.done { color: var(--success); }
        
        /* CALCULATIE SPECIFICS */
        .bus-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .bus-option { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .bus-option:hover { background: #eff6ff; border-color: var(--primary); }
        .bus-option input { width: auto; margin: 0; }
        
        .total-box { background: var(--primary); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px; }
        .total-price { font-size: 32px; font-weight: 800; margin: 5px 0; }
        
        .profit-box { margin-top:10px; padding:10px; background:#ecfdf5; border-radius:8px; border:1px solid #10b981; text-align:center; }
        .profit-amount { font-size:24px; font-weight:800; color:#047857; margin-top: 2px; }

        /* MODAL & PDF STYLING */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: #525659; width: 1000px; max-width: 95%; max-height: 95vh; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { background: #333; color: white; padding: 15px 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 40px; overflow-y: auto; background: #525659; display: flex; justify-content: center; }
        .modal-footer { padding: 15px 20px; background: white; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }

        /* DE PDF 'PAPIER' STIJL - EXACT ZOALS VOORBEELD */
        .pdf-container {
            width: 210mm; min-height: 297mm; padding: 20mm;
            background: white; color: #000; font-family: 'Inter', sans-serif;
            font-size: 10pt; line-height: 1.4; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .pdf-header { display: flex; justify-content: space-between; margin-bottom: 40px; }
        .pdf-logo { font-size: 24px; font-weight: 800; color: #004a99; margin-bottom: 5px; }
        .pdf-meta-right { text-align: right; font-size: 9pt; }
        .pdf-recipient { margin: 30px 0; }
        .pdf-subject { font-weight: bold; margin-bottom: 20px; font-size: 11pt; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 10pt; }
        .pdf-table th { text-align: left; border-bottom: 1px solid #000; padding: 5px 0; font-weight: bold; }
        .pdf-table td { padding: 5px 0; vertical-align: top; }
        .pdf-programma-row { display: flex; margin-bottom: 5px; }
        .pdf-label { width: 140px; font-weight: 600; }
        .pdf-value { flex: 1; }
        .pdf-footer { margin-top: 50px; font-size: 8pt; color: #555; text-align: justify; border-top: 1px solid #eee; padding-top: 10px; }

        /* UTILS */
        .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-green { background: #10b981; color: white; }
        .btn-green:hover { background: #059669; }
        .btn-grey { background: #e5e7eb; color: #374151; }
        .hidden { display: none !important; }
        .search-results { position: absolute; background: white; border: 1px solid var(--primary); width: 100%; max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-item:hover { background: #f0f9ff; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fa-solid fa-bus"></i> BERKHOUT</div>
    <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-calendar-days"></i> Planning</div>
    <div class="nav-item" onclick="nav('calculatie')"><i class="fa-solid fa-calculator"></i> Nieuwe Rit</div>
    <div class="nav-item" onclick="nav('klanten')"><i class="fa-solid fa-users"></i> Klanten</div>
</div>

<div class="main">

    <div id="dashboard" class="page-section active">
        <div class="filter-bar">
            <div class="year-selector">
                <button class="btn" style="background:none;" onclick="changeYear(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="display-year">2026</span>
                <button class="btn" style="background:none;" onclick="changeYear(1)"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <div class="month-grid" id="month-buttons"></div>
        </div>
        <div class="card" style="padding:0; overflow:hidden;">
            <table class="rit-table">
                <thead>
                    <tr><th style="width:40px;"></th><th style="width:90px;">Datum</th><th style="width:140px;">Type</th><th>Klant</th><th>Bestemming</th><th style="text-align:right;">Prijs</th><th style="text-align:center;">Off</th><th style="text-align:center;">Bev</th><th style="text-align:center;">Fac</th><th style="text-align:center;">Bet</th></tr>
                </thead>
                <tbody id="rit-tabel-body"></tbody>
            </table>
            <div id="empty-state" style="padding:40px; text-align:center; color:#999; display:none;">Geen ritten gevonden.</div>
        </div>
    </div>

    <div id="calculatie" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="calc-title">Nieuwe Offerte</h2>
            <button onclick="resetForm()" class="btn-grey" style="font-size:12px;"><i class="fa-solid fa-rotate-left"></i> Reset</button>
        </div>
        <div class="grid-2">
            <div>
                <div class="card">
                    <h3>1. Datum & Klant</h3>
                    <div style="display:flex; gap:15px;">
                        <div style="flex:1;"><label>Startdatum</label><input type="date" id="rit_datum" onchange="syncDates()"></div>
                        <div style="flex:1;"><label>Einddatum</label><input type="date" id="rit_datum_eind" onchange="rekenUren()"></div>
                    </div>
                    
                    <label>Zoek Klant</label>
                    <div style="position:relative;">
                        <input type="text" id="calc-klant-zoek" placeholder="Typ naam..." oninput="filterCalcClients()">
                        <input type="hidden" id="calc-klant-id">
                        <div class="search-results" id="calc-klant-results"></div>
                    </div>
                    
                    <label>Contactpersoon</label>
                    <select id="calc-contact"><option value="">-- Eerst klant kiezen --</option></select>
                    
                    <label>Aantal Personen</label> 
                    <input type="number" id="calc-pax" placeholder="Bijv. 50">

                    <label>Kies Voertuig(en)</label>
                    <div class="bus-grid" id="bus-container"></div>
                </div>

                <div class="card">
                    <h3>2. Route</h3>
                    <label>Vertrek Garage</label><input type="text" id="route-start" value="Industrieweg 95A, Zutphen">
                    <label>Ophaaladres</label><input type="text" id="route-ophaal" placeholder="Zoek adres..." onchange="berekenRoute()">
                    
                    <label>Bestemming</label><input type="text" id="route-eind" placeholder="Zoek bestemming..." onchange="berekenRoute()">
                    
                    <div style="background:#eff6ff; padding:15px; border-radius:8px; margin-top:15px; font-size:14px;">
                        <div style="display:flex; justify-content:space-between;"><span>Reistijd (Enkel):</span><span style="font-weight:bold; color:var(--primary);" id="info-rit">-</span></div>
                        <div style="display:flex; justify-content:space-between; margin-top:5px;"><span>Afstand (Totaal):</span><span style="font-weight:bold; color:var(--primary);" id="info-totaal">0 km</span></div>
                    </div>
                </div>
            </div>

            <div>
                <div class="card">
                    <h3>3. Planning</h3>
                    <label>Type Rit</label>
                    <select id="rit-type" onchange="wisselTijdLijst()" style="font-weight:bold; border:2px solid var(--primary);">
                        <option value="vv" selected>Dagtocht (Volledig)</option>
                        <option value="enkel">Enkele Rit (Brengen)</option>
                        <option value="brenghaal">Breng & Haal (Gesplitst)</option>
                        <option value="meerdaagse">Meerdaagse Rit</option>
                    </select>

                    <div id="tijd-container" style="margin-top:15px;"></div>
                    
                    <div style="text-align:right; font-weight:bold; margin-top:15px; color:var(--primary); font-size:18px;">
                        Facturabele Uren: <span id="uren-display">0.0</span> uur
                    </div>
                </div>

                <div class="card">
                    <h3>4. Prijs & Winst</h3>
                    <label>Extra Kosten (Parkeren/Tol)</label>
                    <input type="number" id="kosten-extra" value="0" oninput="rekenPrijs()">

                    <div class="total-box">
                        <div style="font-size:14px; opacity:0.9;">Totaal incl. 9% BTW</div>
                        <div class="total-price" id="prijs-display">€ 0,00</div>
                        <div style="font-size:13px; opacity:0.9;" id="btw-display">BTW: € 0,00</div>
                    </div>

                    <div class="profit-box">
                        <div class="profit-title">Live Winstmarge</div>
                        <div class="profit-amount" id="live-profit">€ 0</div>
                    </div>
                    
                    <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                         <div style="font-size:12px; font-weight:600; margin-bottom:5px;">Datums (Optioneel):</div>
                         <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                            <input type="date" id="calc-date-offerte" style="font-size:11px;">
                            <input type="date" id="calc-date-bevestiging" style="font-size:11px;">
                            <input type="date" id="calc-date-factuur" style="font-size:11px;">
                         </div>
                    </div>

                    <button id="btn-save" class="btn btn-green" style="width:100%; margin-top:15px;" onclick="opslaan()"><i class="fa-solid fa-save"></i> Opslaan</button>
                </div>
            </div>
        </div>
    </div>

    <div id="klanten" class="page-section">
        <div id="crm-list-view">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2>Klantenbestand</h2>
                <button class="btn btn-green" style="width:auto;" onclick="nieuwKlantScherm()">+ Nieuwe Klant</button>
            </div>
            <div class="card">
                <input type="text" id="crm-search" placeholder="Zoek op naam, plaats..." onkeyup="renderClientList()">
                <table class="rit-table" style="margin-top:10px;">
                    <thead><tr><th>Naam</th><th>Plaats</th><th>Tel</th><th style="width:80px;">Actie</th></tr></thead>
                    <tbody id="crm-table-body"></tbody>
                </table>
            </div>
        </div>
        
        <div id="crm-detail-view" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 id="crm-title">Klant Bewerken</h2>
                <button class="btn btn-grey" style="width:auto;" onclick="terugNaarLijst()">Terug</button>
            </div>
            <div class="card">
                <div class="grid-2">
                    <div><label>Naam</label><input type="text" id="crm-naam"></div>
                    <div><label>Plaats</label><input type="text" id="crm-plaats"></div>
                </div>
                <label>Adres</label><input type="text" id="crm-adres">
                <label>Telefoon</label><input type="text" id="crm-tel">
                <label>Email</label><input type="text" id="crm-email">
                
                <h3>Contactpersonen</h3>
                <div id="crm-contacts-container"></div>
                <button class="btn btn-grey" style="width:auto; margin-top:10px; font-size:12px;" onclick="addContactRow()">+ Contactpersoon</button>
                
                <div style="margin-top:20px;">
                    <button class="btn btn-green" onclick="saveClient()">Klant Opslaan</button>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="offerte-modal" class="hidden modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <span>Offerte Voorbeeld (Klaar voor verzending)</span>
            <span onclick="closeModal('offerte-modal')" style="cursor:pointer;"><i class="fa-solid fa-times"></i></span>
        </div>
        
        <div class="modal-body">
            <div id="pdf-content" class="pdf-container">
                </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-grey" style="width:auto;" onclick="closeModal('offerte-modal')">Annuleren</button>
            <button class="btn btn-green" style="width:auto;" onclick="generateAndMailPDF()">
                <i class="fa-solid fa-paper-plane"></i> Downloaden & Mail Openen
            </button>
        </div>
    </div>
</div>

<script>
    // --- 1. STATE & CONFIG ---
    let db = { klanten: [], ritten: [] };
    let appState = { currentYear: new Date().getFullYear(), currentMonth: new Date().getMonth(), activeRitId: null, activeClientId: null };
    let ritData = { km: 0, ritSec: 0, aanrijSec: 0 };
    
    // Buses: Prijs per KM
    const busOpties = [ 
        {label:'Bus 19', prijs:0.75}, {label:'Bus 23', prijs:0.75}, 
        {label:'Bus 50', prijs:1.00}, {label:'Bus 60', prijs:1.20} 
    ];

    // Tijdschema templates
    const templates = {
        vv: [
            {id:'std_1', l:'Vertrek Garage', h:'08', m:'00'}, {id:'std_2', l:'Voorstaan', h:'08', m:'30'},
            {id:'std_3', l:'Vertrek Klant', h:'08', m:'45'}, {id:'std_4', l:'Aankomst Best.', h:'10', m:'00'},
            {id:'std_5', l:'Retour Best.', h:'16', m:'00'}, {id:'std_6', l:'Aankomst Klant', h:'17', m:'15'},
            {id:'std_7', l:'Aankomst Garage', h:'18', m:'00'}
        ],
        enkel: [
            {id:'std_1', l:'Vertrek Garage', h:'08', m:'00'}, {id:'std_3', l:'Vertrek Klant', h:'08', m:'45'},
            {id:'std_4', l:'Aankomst Best.', h:'10', m:'00'}, {id:'std_7', l:'Aankomst Garage', h:'11', m:'00'}
        ]
    };

    // --- 2. INITIALISATIE ---
    window.initApp = function() {
        const saved = localStorage.getItem('berkhout_v3');
        if(saved) db = JSON.parse(saved);
        
        // Zorg dat datastructuur klopt
        db.klanten.forEach(k => { if(!k.contactpersonen) k.contactpersonen = []; });
        
        setupUI();
        initMaps();
        renderMonthButtons();
        updateDashboard();
        
        // Zet vandaag
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('rit_datum').value = today;
        document.getElementById('rit_datum_eind').value = today;
    };

    function setupUI() {
        // Bouw bus checkboxes
        const c = document.getElementById('bus-container');
        c.innerHTML = busOpties.map((b,i) => `
            <label class="bus-option">
                <input type="checkbox" class="bus-check" value="${i}" onchange="rekenPrijs()">
                <span><b>${b.label}</b><br><small>€${b.prijs.toFixed(2)}/km</small></span>
            </label>
        `).join('');
        
        wisselTijdLijst(); // Init tijden
    }

    // --- 3. GOOGLE MAPS ---
    function initMaps() {
        const opts = { componentRestrictions: {country:'nl'} };
        ['route-start','route-ophaal','route-eind','crm-adres'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                const ac = new google.maps.places.Autocomplete(el, opts);
                ac.addListener('place_changed', () => {
                    if(id === 'crm-adres') {
                        const p = ac.getPlace();
                        let stad = '';
                        p.address_components.forEach(c => { if(c.types.includes('locality')) stad = c.long_name; });
                        document.getElementById('crm-plaats').value = stad;
                    } else {
                        berekenRoute();
                    }
                });
            }
        });
    }

    function berekenRoute() {
        const s = document.getElementById('route-start').value;
        const o = document.getElementById('route-ophaal').value;
        const e = document.getElementById('route-eind').value;
        
        if(!s || !o || !e) return;

        const svc = new google.maps.DirectionsService();
        svc.route({
            origin: s, destination: e, 
            waypoints: [{location: o, stopover: true}],
            travelMode: 'DRIVING'
        }, (res, stat) => {
            if(stat === 'OK') {
                const legs = res.routes[0].legs;
                // Leg 0: Garage -> Klant, Leg 1: Klant -> Bestemming
                ritData.aanrijSec = legs[0].duration.value;
                ritData.ritSec = legs[1].duration.value;
                
                // Totaal afstand (heenreis x2 voor dagtocht logica, of specifiek berekenen)
                let totalMeters = 0;
                legs.forEach(l => totalMeters += l.distance.value);
                
                // Simpele logica: Totaal KM = (Garage->Klant->Bestemming) * 2 voor Dagtocht
                ritData.km = Math.round((totalMeters * 2) / 1000); 

                document.getElementById('info-rit').innerText = Math.round(ritData.ritSec/60) + ' min';
                document.getElementById('info-totaal').innerText = ritData.km + ' km (Retour)';
                
                rekenUren();
            }
        });
    }

    // --- 4. CALCULATIE & PRIJS ---
    function syncDates() { document.getElementById('rit_datum_eind').value = document.getElementById('rit_datum').value; rekenUren(); }

    function wisselTijdLijst() {
        const type = document.getElementById('rit-type').value;
        const list = (type === 'enkel') ? templates.enkel : templates.vv; // Versimpeld voor demo
        
        const container = document.getElementById('tijd-container');
        container.innerHTML = list.map(t => `
            <div style="display:flex; align-items:center; margin-bottom:5px; background:#fff; padding:5px; border:1px solid #eee; border-radius:4px;">
                <span style="flex:1; font-size:12px; font-weight:600;">${t.l}</span>
                <input type="number" id="h_${t.id}" value="${t.h}" class="time-in" style="width:40px; text-align:center;"> :
                <input type="number" id="m_${t.id}" value="${t.m}" class="time-in" style="width:40px; text-align:center;">
            </div>
        `).join('');
        
        // Add listeners
        document.querySelectorAll('.time-in').forEach(el => el.addEventListener('change', rekenUren));
        rekenUren();
    }

    function rekenUren() {
        // Simpele uren berekening: Laatste tijdstip - Eerste tijdstip
        const type = document.getElementById('rit-type').value;
        let startId = 'std_1';
        let endId = (type === 'enkel') ? 'std_7' : 'std_7';
        
        const h1 = parseInt(document.getElementById('h_'+startId)?.value || 8);
        const m1 = parseInt(document.getElementById('m_'+startId)?.value || 0);
        const h2 = parseInt(document.getElementById('h_'+endId)?.value || 18);
        const m2 = parseInt(document.getElementById('m_'+endId)?.value || 0);
        
        let start = new Date(2000, 0, 1, h1, m1);
        let end = new Date(2000, 0, 1, h2, m2);
        
        let uren = (end - start) / 3600000;
        if(uren < 0) uren = 0; // Nachtwerk negeren we even voor demo
        
        document.getElementById('uren-display').innerText = uren.toFixed(2);
        rekenPrijs();
    }

    function rekenPrijs() {
        const km = ritData.km;
        const uren = parseFloat(document.getElementById('uren-display').innerText);
        const extra = parseFloat(document.getElementById('kosten-extra').value) || 0;
        
        // Tel bussen en hun km prijs
        let busCount = 0;
        let kmPrijsTotaal = 0;
        document.querySelectorAll('.bus-check:checked').forEach(cb => {
            busCount++;
            kmPrijsTotaal += busOpties[cb.value].prijs;
        });

        if(busCount === 0) {
            updatePrijsUI(0, 0);
            return;
        }

        // Kostprijs berekening (Schatting)
        const kostprijs = (km * kmPrijsTotaal) + (uren * 35 * busCount) + extra;
        
        // Verkoopprijs berekening
        // Stel: we willen minstens 10% marge op de rit + overhead dekking
        // Formule: Kostprijs * 1.3 (Grove marge) + BTW
        let verkoopExcl = kostprijs * 1.3;
        
        // Afronden op 25 euro
        verkoopExcl = Math.ceil(verkoopExcl / 25) * 25;
        if(verkoopExcl < 150) verkoopExcl = 150; // Minimum starttarief

        const verkoopIncl = verkoopExcl * 1.09;
        
        updatePrijsUI(verkoopIncl, kostprijs);
    }

    function updatePrijsUI(incl, kost) {
        const excl = incl / 1.09;
        const btw = incl - excl;
        const winst = excl - kost;

        document.getElementById('prijs-display').innerText = '€ ' + incl.toLocaleString('nl-NL', {minimumFractionDigits:2, maximumFractionDigits:2});
        document.getElementById('btw-display').innerText = 'BTW (9%): € ' + btw.toLocaleString('nl-NL', {minimumFractionDigits:2, maximumFractionDigits:2});
        
        const winstEl = document.getElementById('live-profit');
        winstEl.innerText = '€ ' + Math.round(winst);
        winstEl.style.color = winst > 0 ? '#047857' : '#ef4444';
    }

    // --- 5. CRM ---
    function nieuwKlantScherm() {
        appState.activeClientId = null;
        document.getElementById('crm-title').innerText = "Nieuwe Klant";
        ['crm-naam','crm-adres','crm-plaats','crm-tel','crm-email'].forEach(id => document.getElementById(id).value='');
        document.getElementById('crm-contacts-container').innerHTML = '';
        addContactRow();
        switchCrmView(true);
    }
    
    function addContactRow(data={}) {
        const d = document.createElement('div');
        d.className = 'contact-row';
        d.innerHTML = `<input type="text" placeholder="Naam" value="${data.naam||''}" style="margin-bottom:5px;"> <input type="text" placeholder="Email" value="${data.email||''}">`;
        document.getElementById('crm-contacts-container').appendChild(d);
    }

    function saveClient() {
        const naam = document.getElementById('crm-naam').value;
        if(!naam) return alert("Naam verplicht");
        
        const contacts = [];
        document.querySelectorAll('.contact-row').forEach(r => {
            const i = r.querySelectorAll('input');
            if(i[0].value) contacts.push({naam: i[0].value, email: i[1].value});
        });

        const client = {
            id: appState.activeClientId || Date.now(),
            naam, 
            adres: document.getElementById('crm-adres').value,
            plaats: document.getElementById('crm-plaats').value,
            tel: document.getElementById('crm-tel').value,
            email: document.getElementById('crm-email').value,
            contactpersonen: contacts
        };

        if(appState.activeClientId) {
            const idx = db.klanten.findIndex(x => x.id === appState.activeClientId);
            db.klanten[idx] = client;
        } else {
            db.klanten.push(client);
        }
        
        saveDB();
        renderClientList();
        terugNaarLijst();
    }

    function renderClientList() {
        const q = document.getElementById('crm-search').value.toLowerCase();
        const tbody = document.getElementById('crm-table-body');
        tbody.innerHTML = '';
        
        db.klanten.filter(k => k.naam.toLowerCase().includes(q) || k.plaats.toLowerCase().includes(q)).forEach(k => {
            tbody.innerHTML += `
                <tr>
                    <td><b>${k.naam}</b></td><td>${k.plaats}</td><td>${k.tel}</td>
                    <td><button class="btn btn-grey" onclick="startOfferte(${k.id})" style="padding:5px 10px;"><i class="fa-solid fa-arrow-right"></i></button></td>
                </tr>
            `;
        });
    }

    // --- 6. OPSLAAN & DASHBOARD ---
    function opslaan() {
        const datum = document.getElementById('rit_datum').value;
        const klantNaam = document.getElementById('calc-klant-zoek').value;
        if(!klantNaam) return alert("Kies een klant");

        const rit = {
            id: appState.activeRitId || Date.now(),
            datum,
            klant: klantNaam,
            dest: document.getElementById('route-eind').value,
            prijs: document.getElementById('prijs-display').innerText,
            status: (appState.activeRitId ? db.ritten.find(r=>r.id==appState.activeRitId).status : {offerte:false, bevestiging:false, factuur:false, betaald:false}),
            history: {
                offerte: document.getElementById('calc-date-offerte').value,
                bevestiging: document.getElementById('calc-date-bevestiging').value,
                factuur: document.getElementById('calc-date-factuur').value
            },
            details: {
                rit_datum_eind: document.getElementById('rit_datum_eind').value,
                klantId: document.getElementById('calc-klant-id').value,
                contactIdx: document.getElementById('calc-contact').value,
                pax: document.getElementById('calc-pax').value,
                route: {
                    start: document.getElementById('route-start').value,
                    ophaal: document.getElementById('route-ophaal').value,
                    eind: document.getElementById('route-eind').value
                },
                tijden: getTijden(),
                bussen: Array.from(document.querySelectorAll('.bus-check:checked')).map(c => c.value)
            }
        };

        if(appState.activeRitId) {
            const idx = db.ritten.findIndex(r => r.id == appState.activeRitId);
            db.ritten[idx] = rit;
        } else {
            db.ritten.unshift(rit);
        }

        saveDB();
        resetForm();
        nav('dashboard');
        updateDashboard();
    }

    function updateDashboard() {
        const body = document.getElementById('rit-tabel-body');
        body.innerHTML = '';
        
        // Filter op jaar/maand
        const filtered = db.ritten.filter(r => {
            const d = new Date(r.datum);
            return d.getFullYear() === appState.currentYear && 
                   (appState.currentMonth === -1 || d.getMonth() === appState.currentMonth);
        }).sort((a,b) => new Date(a.datum) - new Date(b.datum));

        if(filtered.length === 0) {
            document.getElementById('empty-state').style.display = 'block';
            return;
        }
        document.getElementById('empty-state').style.display = 'none';

        filtered.forEach(r => {
            const d = new Date(r.datum);
            const dateStr = `${d.getDate()}-${d.getMonth()+1}`;
            const s = r.status;
            
            body.innerHTML += `
                <tr>
                    <td><button onclick="laadRit(${r.id})" style="border:none; bg:none; cursor:pointer;"><i class="fa-solid fa-pen"></i></button></td>
                    <td><b>${dateStr}</b></td>
                    <td><span class="tag tag-blue">Dagtocht</span></td>
                    <td>${r.klant}</td>
                    <td>${r.dest}</td>
                    <td style="text-align:right;">${r.prijs}</td>
                    
                    <td class="status-cell" onclick="toggleStatus(${r.id}, 'offerte')">
                        <i class="status-icon fa-solid fa-circle-check ${s.offerte?'done':''}"></i>
                    </td>
                    <td class="status-cell" onclick="toggleStatus(${r.id}, 'bevestiging')">
                        <i class="status-icon fa-solid fa-circle-check ${s.bevestiging?'done':''}"></i>
                    </td>
                    <td class="status-cell" onclick="toggleStatus(${r.id}, 'factuur')">
                        <i class="status-icon fa-solid fa-circle-check ${s.factuur?'done':''}"></i>
                    </td>
                    <td class="status-cell" onclick="toggleStatus(${r.id}, 'betaald')">
                        <i class="status-icon fa-solid fa-circle-check ${s.betaald?'done':''}"></i>
                    </td>
                </tr>
            `;
        });
    }

    // --- 7. PDF GENERATIE (NIEUW) ---
    function toggleStatus(id, type) {
        const rit = db.ritten.find(r => r.id === id);
        if(type === 'offerte' && !rit.status.offerte) {
            appState.activeRitId = id;
            openOfferteModal(); // Open de preview
        } else {
            rit.status[type] = !rit.status[type];
            // Zet datum stempel als nog niet bestaat
            if(rit.status[type] && !rit.history[type]) {
                rit.history[type] = new Date().toISOString().split('T')[0];
            }
            saveDB();
            updateDashboard();
        }
    }

    function openOfferteModal() {
        const rit = db.ritten.find(r => r.id === appState.activeRitId);
        const klant = db.klanten.find(k => k.id == rit.details.klantId);
        
        // Data Formatting
        const today = new Date().toLocaleDateString('nl-NL');
        const vertrekDatum = new Date(rit.datum).toLocaleDateString('nl-NL');
        const eindDatum = rit.details.rit_datum_eind ? new Date(rit.details.rit_datum_eind).toLocaleDateString('nl-NL') : vertrekDatum;
        
        // Prijs splitsen
        const prijsRaw = parseFloat(rit.prijs.replace(/[^0-9,-]+/g,"").replace(',','.'));
        const excl = prijsRaw / 1.09;
        const btw = prijsRaw - excl;

        // Contactpersoon
        let attn = "T.a.v. Contactpersoon";
        if(rit.details.contactIdx !== "" && klant && klant.contactpersonen[rit.details.contactIdx]) {
            attn = "T.a.v. " + klant.contactpersonen[rit.details.contactIdx].naam;
        }

        // Tijden ophalen
        const t = rit.details.tijden;

        // HTML Bouwen (De 'Paper' look)
        const html = `
            <div class="pdf-header">
                <div class="pdf-address-col">
                    <div class="pdf-logo">Berkhout Busreizen</div>
                    Industrieweg 95A<br>
                    7202 CA Zutphen<br>
                    0575-525345<br>
                    info@berkhoutreizen.nl<br>
                    www.berkhoutreizen.nl
                </div>
                <div class="pdf-meta-right">
                    <div style="font-size:12pt; font-weight:bold; color:#004a99; margin-bottom:10px;">Snel, veilig & comfortabel</div>
                    <strong>Datum:</strong> ${today}<br>
                    <strong>Kenmerk:</strong> OFF-${rit.id}
                </div>
            </div>

            <div class="pdf-recipient">
                <strong>${klant ? klant.naam : rit.klant}</strong><br>
                ${attn}<br>
                ${klant ? klant.adres : ''}<br>
                ${klant ? klant.plaats : ''}
            </div>

            <div class="pdf-subject">Betreft: uw offerte</div>

            <div style="margin-bottom:20px;">
                Geachte heer/mevrouw,<br><br>
                Wij danken u voor uw aanvraag en hebben hierbij het genoegen u een vrijblijvende offerte, op basis van beschikbaarheid, te doen toekomen.
                Hieronder volgt het programma zoals is besproken en de kosten hiervoor.
            </div>

            <h3 style="border-bottom:1px solid #000; padding-bottom:5px; margin-bottom:10px;">Programma</h3>
            
            <table class="pdf-table">
                <tr><td style="width:150px;"><strong>Vertrekdatum:</strong></td><td>${vertrekDatum}</td></tr>
                <tr><td><strong>Einddatum:</strong></td><td>${eindDatum}</td></tr>
                <tr><td><strong>Aantal passagiers:</strong></td><td>${rit.details.pax || '-'}</td></tr>
                <tr><td><strong>Aantal touringcars:</strong></td><td>${rit.details.bussen.length}</td></tr>
            </table>

            <div style="margin-bottom:30px;">
                <div class="pdf-programma-row"><div class="pdf-label">Vertrekadres:</div><div class="pdf-value">${rit.details.route.start}</div></div>
                <div class="pdf-programma-row"><div class="pdf-label">Vertrektijd:</div><div class="pdf-value">${t.h_std_1 || '..'}:${t.m_std_1 || '00'} uur</div></div>
                
                <div class="pdf-programma-row" style="margin-top:10px;"><div class="pdf-label">Ophaaladres:</div><div class="pdf-value">${rit.details.route.ophaal}</div></div>
                <div class="pdf-programma-row"><div class="pdf-label">Tijd Klant:</div><div class="pdf-value">${t.h_std_3 || '..'}:${t.m_std_3 || '00'} uur</div></div>

                <div class="pdf-programma-row" style="margin-top:10px;"><div class="pdf-label">Bestemming:</div><div class="pdf-value">${rit.details.route.eind}</div></div>
                <div class="pdf-programma-row"><div class="pdf-label">Aankomst:</div><div class="pdf-value">${t.h_std_4 || '..'}:${t.m_std_4 || '00'} uur</div></div>
                
                <div class="pdf-programma-row" style="margin-top:10px;"><div class="pdf-label">Retour Vertrek:</div><div class="pdf-value">${t.h_std_5 || '..'}:${t.m_std_5 || '00'} uur</div></div>
                <div class="pdf-programma-row"><div class="pdf-label">Retour Garage:</div><div class="pdf-value">${t.h_std_7 || '..'}:${t.m_std_7 || '00'} uur</div></div>
            </div>

            <h3 style="border-bottom:1px solid #000; padding-bottom:5px; margin-bottom:10px;">Financieel Overzicht</h3>

            <table class="pdf-table" style="border:1px solid #eee;">
                <tr style="background:#f9f9f9;">
                    <th style="padding:10px;">Omschrijving</th>
                    <th style="text-align:right; padding:10px;">Bedrag</th>
                </tr>
                <tr>
                    <td style="padding:10px;">Vervoerskosten (excl. BTW)</td>
                    <td style="text-align:right; padding:10px;">€ ${excl.toLocaleString('nl-NL',{minimumFractionDigits:2})}</td>
                </tr>
                 <tr>
                    <td style="padding:10px;">BTW (9%)</td>
                    <td style="text-align:right; padding:10px;">€ ${btw.toLocaleString('nl-NL',{minimumFractionDigits:2})}</td>
                </tr>
                <tr style="font-weight:bold; font-size:11pt; border-top:1px solid #000;">
                    <td style="padding:10px;">Totaalprijs incl. BTW</td>
                    <td style="text-align:right; padding:10px;">€ ${prijsRaw.toLocaleString('nl-NL',{minimumFractionDigits:2})}</td>
                </tr>
            </table>

            <div class="pdf-footer">
                <strong>Voorwaarden:</strong><br>
                Indien van het bovenstaande programma wordt afgeweken, kan er een prijsaanpassing volgen.
                De aanbieding is exclusief eventuele parkeer-, tol- en/of verblijfskosten. Wij behouden ons het recht voor onze reissommen te wijzigen, indien daartoe aanleiding bestaat door prijs en/of brandstofverhogingen door derden.<br><br>
                Wij vertrouwen erop u met deze offerte een passende aanbieding te hebben gedaan en zien uw reactie gaarne tegemoet.<br><br>
                Met vriendelijke groeten,<br>
                <strong>Berkhout Reizen</strong><br>
                Fred Stravers
            </div>
        `;
        
        document.getElementById('pdf-content').innerHTML = html;
        document.getElementById('offerte-modal').classList.remove('hidden');
    }

    function generateAndMailPDF() {
        const rit = db.ritten.find(r => r.id === appState.activeRitId);
        const element = document.getElementById('pdf-content');
        
        const opt = {
            margin: 0,
            filename: `Offerte_Berkhout_${rit.klant.replace(/\s/g,'_')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            // Update Status
            rit.status.offerte = true;
            rit.history.offerte = new Date().toISOString().split('T')[0];
            saveDB();
            updateDashboard();
            closeModal('offerte-modal');

            // Mail openen
            const klant = db.klanten.find(k => k.id == rit.details.klantId);
            const email = (klant && klant.contactpersonen[0]) ? klant.contactpersonen[0].email : '';
            const sub = encodeURIComponent(`Offerte Berkhout: ${rit.dest}`);
            const body = encodeURIComponent(`Geachte relatie,\n\nHierbij ontvangt u de offerte. (Vergeet niet de PDF bij te voegen).\n\nMvg, Berkhout`);
            
            window.location.href = `mailto:${email}?subject=${sub}&body=${body}`;
        });
    }

    // --- HELPER FUNCTIES ---
    function saveDB() { localStorage.setItem('berkhout_v3', JSON.stringify(db)); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function nav(id) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    function resetForm() {
        appState.activeRitId = null;
        document.getElementById('calc-title').innerText = "Nieuwe Offerte";
        document.querySelectorAll('input:not(#route-start)').forEach(i => i.value = '');
        document.getElementById('rit_datum').value = new Date().toISOString().split('T')[0];
        setupUI();
        document.getElementById('calc-klant-zoek').value = '';
        document.getElementById('prijs-display').innerText = "€ 0,00";
        document.getElementById('live-profit').innerText = "€ 0";
    }
    // Filter & CRM Helpers
    function filterCalcClients() {
        const q = document.getElementById('calc-klant-zoek').value.toLowerCase();
        const res = document.getElementById('calc-klant-results');
        res.innerHTML = '';
        if(q.length < 2) { res.style.display='none'; return; }
        
        db.klanten.filter(k => k.naam.toLowerCase().includes(q)).forEach(k => {
            res.style.display = 'block';
            res.innerHTML += `<div class="search-item" onclick="selectKlant(${k.id})"><b>${k.naam}</b> (${k.plaats})</div>`;
        });
    }
    function selectKlant(id) {
        const k = db.klanten.find(x => x.id === id);
        document.getElementById('calc-klant-zoek').value = k.naam;
        document.getElementById('calc-klant-id').value = k.id;
        document.getElementById('calc-klant-results').style.display='none';
        document.getElementById('route-ophaal').value = k.adres + ', ' + k.plaats;
        
        const sel = document.getElementById('calc-contact');
        sel.innerHTML = k.contactpersonen.map((c,i) => `<option value="${i}">${c.naam}</option>`).join('');
        berekenRoute();
    }
    function startOfferte(clientId) {
        resetForm();
        nav('calculatie');
        selectKlant(clientId);
    }
    function switchCrmView(detail) {
        document.getElementById('crm-list-view').classList.toggle('hidden', detail);
        document.getElementById('crm-detail-view').classList.toggle('hidden', !detail);
    }
    function terugNaarLijst() { switchCrmView(false); }
    function changeYear(d) { appState.currentYear += d; document.getElementById('display-year').innerText = appState.currentYear; updateDashboard(); }
    function renderMonthButtons() {
        const m = ['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
        document.getElementById('month-buttons').innerHTML = 
            `<button class="month-btn ${appState.currentMonth===-1?'active':''}" onclick="appState.currentMonth=-1;renderMonthButtons();updateDashboard()">Alle</button>` +
            m.map((n,i) => `<button class="month-btn ${appState.currentMonth===i?'active':''}" onclick="appState.currentMonth=${i};renderMonthButtons();updateDashboard()">${n}</button>`).join('');
    }
    function getTijden() {
        let t = {};
        document.querySelectorAll('.time-in').forEach(el => t[el.id] = el.value);
        return t;
    }
    function laadRit(id) {
        appState.activeRitId = id;
        const r = db.ritten.find(x => x.id === id);
        nav('calculatie');
        document.getElementById('calc-title').innerText = "Offerte Bewerken";
        document.getElementById('rit_datum').value = r.datum;
        document.getElementById('rit_datum_eind').value = r.details.rit_datum_eind;
        selectKlant(parseInt(r.details.klantId));
        document.getElementById('route-eind').value = r.details.route.eind;
        document.getElementById('kosten-extra').value = r.details.extra || 0;
        
        // Laad datums
        document.getElementById('calc-date-offerte').value = r.history.offerte || '';
        document.getElementById('calc-date-bevestiging').value = r.history.bevestiging || '';
        document.getElementById('calc-date-factuur').value = r.history.factuur || '';
        
        // Zet tijden terug
        setTimeout(() => {
            for(const [k,v] of Object.entries(r.details.tijden)) {
                if(document.getElementById(k)) document.getElementById(k).value = v;
            }
            rekenUren();
        }, 100);
    }

</script>
</body>
</html>
