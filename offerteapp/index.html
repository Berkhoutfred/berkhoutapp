<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berkhout Totaal Systeem</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAi1U8gP0dlE87sYaUDI2JbKKFxJW_YjlY&libraries=places"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #004a99;
            --secondary: #003366;
            --accent: #28a745;
            --bg: #f4f6f9;
            --sidebar-width: 250px;
            --text-dark: #333;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text-dark); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .logo { font-size: 20px; font-weight: 900; margin-bottom: 40px; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; font-size: 15px; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.2); font-weight: bold; }
        .sidebar-footer { margin-top: auto; font-size: 11px; opacity: 0.6; text-align: center; }

        /* MAIN */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: bold; color: var(--secondary); }

        /* CARDS & FORMS */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e0e0e0; }
        .section-header { font-size: 16px; font-weight: bold; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }

        label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; box-sizing: border-box; margin-bottom: 10px; }
        
        /* TIJDEN TABEL */
        .time-row { display: grid; grid-template-columns: 140px 100px 1fr; align-items: center; gap: 10px; margin-bottom: 8px; padding: 8px; background: #f9f9fc; border-radius: 6px; border: 1px solid #eee; }
        .time-label { font-weight: 600; font-size: 13px; }
        .google-time { font-size: 11px; color: #888; font-style: italic; }

        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        th { color: #888; font-weight: 600; font-size: 12px; text-transform: uppercase; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .status-offerte { background: #e3f2fd; color: #1976d2; }
        .status-opdracht { background: #e8f5e9; color: #2e7d32; }

        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .total-block { background: #eef6ff; border: 2px solid var(--primary); padding: 20px; text-align: right; border-radius: 8px; margin-top: 20px; }
        .total-price { font-size: 32px; font-weight: 900; color: var(--primary); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fa-solid fa-bus"></i> BERKHOUT</div>
        <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-chart-line"></i> Dashboard</div>
        <div class="nav-item" onclick="nav('nieuwe-rit')"><i class="fa-solid fa-calculator"></i> Calculatie / Offerte</div>
        <div class="nav-item" onclick="nav('klanten')"><i class="fa-solid fa-users"></i> Klantenbestand</div>
        <div class="sidebar-footer">v1.3 - Totaal Systeem</div>
    </div>

    <div class="main">
        
        <div id="dashboard" class="page-section active">
            <div class="header"><div class="page-title">Overzicht</div><button class="btn btn-primary" onclick="nav('nieuwe-rit')">+ Nieuwe Calculatie</button></div>
            <div class="grid-3">
                <div class="card"><div style="font-size:30px; font-weight:bold; color:var(--primary)" id="count-offertes">0</div><div>Openstaande Offertes</div></div>
                <div class="card"><div style="font-size:30px; font-weight:bold; color:var(--accent)" id="count-opdrachten">0</div><div>Bevestigde Ritten</div></div>
                <div class="card"><div style="font-size:30px; font-weight:bold; color:#666" id="count-klanten">0</div><div>Klanten</div></div>
            </div>
            <div class="card">
                <div class="section-header">Recente Ritten</div>
                <table id="recent-table">
                    <thead><tr><th>Datum</th><th>Klant</th><th>Bus</th><th>Bestemming</th><th>Bedrag</th><th>Status</th><th>Actie</th></tr></thead>
                    <tbody id="recent-body"></tbody>
                </table>
            </div>
        </div>

        <div id="nieuwe-rit" class="page-section">
            <div class="header"><div class="page-title">Nieuwe Rit</div></div>
            <div class="grid-2">
                <div>
                    <div class="card">
                        <div class="section-header">1. Klant & Bus</div>
                        <select id="calc-klant-select" onchange="vulKlantInCalc()"><option value="">-- Kies Klant --</option></select>
                        
                        <div class="grid-2" style="margin-top:10px;">
                            <div>
                                <label>Aantal Personen</label>
                                <input type="number" id="aantal-pax" placeholder="0">
                            </div>
                            <div>
                                <label>Type Bus</label>
                                <select id="bus-type">
                                    <option value="50">50-persoons Touringcar</option>
                                    <option value="60">60-persoons Touringcar</option>
                                    <option value="19">19-persoons Midibus</option>
                                    <option value="Combi">Combinatie / Meerdere</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header">2. Route (Google Routeplanner)</div>
                        <label>Vertrek (Garage)</label>
                        <input type="text" id="route-start" value="Industrieweg 99J, Zutphen">
                        
                        <label>Via Locatie 1 (Optioneel)</label>
                        <input type="text" id="route-via-1" placeholder="Tussenstop..." onchange="berekenRoute()">
                        
                        <label>Via Locatie 2 (Optioneel)</label>
                        <input type="text" id="route-via-2" placeholder="Tussenstop..." onchange="berekenRoute()">
                        
                        <label>Eindbestemming</label>
                        <input type="text" id="route-eind" placeholder="Bestemming..." onchange="berekenRoute()">
                        
                        <div style="background:#f0f7ff; padding:10px; border-radius:6px; font-weight:bold; color:var(--primary); text-align:center;">
                            Totale Afstand: <span id="display-km-retour">0</span> km (Retour)
                        </div>
                        <input type="hidden" id="val-km-retour" value="0">
                    </div>
                </div>

                <div>
                    <div class="card">
                        <div class="section-header">3. Tijdsplanning</div>
                        
                        <div class="time-row">
                            <div class="time-label">1. Vertrek Garage</div>
                            <input type="time" id="t-vertrek-zaak" step="900" onchange="rekenUren()">
                            <span class="google-time"></span>
                        </div>
                        
                        <div class="time-row" style="border-left: 3px solid var(--accent);">
                            <div class="time-label">2. Voorstaan</div>
                            <input type="time" id="t-voorstaan" step="900" readonly style="background:#eee; color:#666;">
                            <span class="google-time"><i class="fa-solid fa-clock"></i> 15 min voor vertrek</span>
                        </div>

                        <div class="time-row" style="border-left: 3px solid var(--accent);">
                            <div class="time-label">3. Vertrek Klant</div>
                            <input type="time" id="t-vertrek-klant" step="900" onchange="autoVoorstaan(); rekenUren()">
                            <span class="google-time" id="gt-naar-klant"></span>
                        </div>

                        <div class="time-row">
                            <div class="time-label">4. Aankomst Loc.</div>
                            <input type="time" id="t-aankomst-loc" step="900" onchange="rekenUren()">
                            <span class="google-time" id="gt-naar-bestemming"></span>
                        </div>

                        <div style="text-align:center; font-size:11px; color:#888; margin:5px 0;">-- Verblijf op Locatie --</div>

                        <div class="time-row">
                            <div class="time-label">5. Vertrek Loc.</div>
                            <input type="time" id="t-vertrek-loc" step="900" onchange="rekenUren()">
                            <span class="google-time"></span>
                        </div>

                        <div class="time-row">
                            <div class="time-label">6. Retour Klant</div>
                            <input type="time" id="t-retour-klant" step="900" onchange="rekenUren()">
                            <span class="google-time" id="gt-terug-klant"></span>
                        </div>

                        <div class="time-row">
                            <div class="time-label">7. Aankomst Garage</div>
                            <input type="time" id="t-aankomst-zaak" step="900" onchange="rekenUren()">
                            <span class="google-time" id="gt-terug-garage"></span>
                        </div>
                        
                        <div style="font-weight:bold; text-align:right; margin-top:10px; font-size:16px;">
                            Totale Inzet: <span id="display-uren" style="color:var(--primary)">0.0</span> uur
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header">4. Totaal & Offerte</div>
                        <label>Overige kosten</label>
                        <input type="number" id="kosten-overig" value="0" oninput="rekenPrijs()">
                        
                        <div class="total-block">
                            <div style="font-size:12px; color:#666;">Totaal incl. 9% BTW</div>
                            <div class="total-price" id="eind-totaal">€ 200,00</div>
                            <div style="font-size:11px; color:#28a745;">(Winstmarge ~33% | Afgerond)</div>
                        </div>
                        <button class="btn btn-primary" style="width:100%; justify-content:center; margin-top:15px;" onclick="slaRitOp()"><i class="fa-solid fa-save"></i> Opslaan</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="klanten" class="page-section">
            <div class="header"><div class="page-title">Klanten</div><button class="btn btn-success" onclick="toggleNieuweKlant()">+ Nieuwe Klant</button></div>
            <div id="nieuw-klant-form" class="card" style="display:none; border:2px solid var(--primary);">
                <div class="section-header">Nieuwe Klant</div>
                <label style="color:var(--primary);">Zoek Bedrijf (Google)</label>
                <input type="text" id="google-bedrijf-zoek" placeholder="Typ naam...">
                <div class="grid-2">
                    <input type="text" id="nk-naam" placeholder="Naam">
                    <input type="text" id="nk-contact" placeholder="Contactpersoon">
                    <input type="email" id="nk-email" placeholder="Email">
                    <input type="text" id="nk-adres" placeholder="Adres">
                    <input type="text" id="nk-plaats" placeholder="Plaats">
                </div>
                <button class="btn btn-primary" onclick="slaKlantOp()">Opslaan</button>
            </div>
            <div class="card"><table id="klanten-tabel"><thead><tr><th>Naam</th><th>Plaats</th><th>Actie</th></tr></thead><tbody id="klanten-body"></tbody></table></div>
        </div>

    </div>

    <script>
        let db = { klanten: [], ritten: [] };
        let googleTimes = {}; // Opslag voor reistijden

        function initApp() {
            const opgeslagen = localStorage.getItem('berkhout_erp_v1');
            if(opgeslagen) db = JSON.parse(opgeslagen);
            updateDashboard();
            vulKlantenLijst();
            initGoogleMaps();
        }

        function saveData() {
            localStorage.setItem('berkhout_erp_v1', JSON.stringify(db));
            updateDashboard();
            vulKlantenLijst();
        }

        function nav(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // --- GOOGLE ROUTE & AUTOCOMPLETE ---
        function initGoogleMaps() {
            const options = { types: ['address'], componentRestrictions: {country: 'nl'} };
            
            new google.maps.places.Autocomplete(document.getElementById('route-start'), options);
            new google.maps.places.Autocomplete(document.getElementById('route-via-1'), options);
            new google.maps.places.Autocomplete(document.getElementById('route-via-2'), options);
            const autoEind = new google.maps.places.Autocomplete(document.getElementById('route-eind'), options);
            autoEind.addListener('place_changed', berekenRoute);

            // Bedrijf zoeker
            const autoBedrijf = new google.maps.places.Autocomplete(document.getElementById('google-bedrijf-zoek'), { types: ['establishment'] });
            autoBedrijf.addListener('place_changed', () => {
                const p = autoBedrijf.getPlace();
                document.getElementById('nk-naam').value = p.name || '';
                if(p.address_components) {
                   // Simpele adres invul logica
                   document.getElementById('nk-adres').value = p.formatted_address;
                }
            });
        }

        function berekenRoute() {
            const start = document.getElementById('route-start').value;
            const eind = document.getElementById('route-eind').value;
            const via1 = document.getElementById('route-via-1').value;
            const via2 = document.getElementById('route-via-2').value;

            if(!start || !eind) return;

            const waypoints = [];
            if(via1) waypoints.push({location: via1, stopover: true});
            if(via2) waypoints.push({location: via2, stopover: true});

            const directionsService = new google.maps.DirectionsService();
            
            // 1. Garage -> Klant (Via's?) -> Bestemming
            directionsService.route({
                origin: start,
                destination: eind,
                waypoints: waypoints,
                travelMode: 'DRIVING'
            }, (response, status) => {
                if (status === 'OK') {
                    let totalDist = 0;
                    let totalDuration = 0; // seconden
                    const legs = response.routes[0].legs;

                    // Totale afstand optellen
                    legs.forEach(leg => {
                        totalDist += leg.distance.value;
                        totalDuration += leg.duration.value;
                    });

                    // We doen retour, dus x2
                    const retourKm = Math.round((totalDist / 1000) * 2);
                    document.getElementById('display-km-retour').innerText = retourKm;
                    document.getElementById('val-km-retour').value = retourKm;

                    // Google Tijd Indicatie tonen
                    const heenUur = Math.floor(totalDuration / 3600);
                    const heenMin = Math.round((totalDuration % 3600) / 60);
                    
                    // Vul indicaties in tabel
                    const textTime = `${heenUur}u ${heenMin}m rijden`;
                    document.getElementById('gt-naar-bestemming').innerText = `(Google indicatie: ${textTime})`;
                    
                    rekenPrijs();
                }
            });
        }

        // --- TIJDEN LOGICA ---
        function autoVoorstaan() {
            const vertrekKlant = document.getElementById('t-vertrek-klant').value;
            if(!vertrekKlant) return;

            const [h, m] = vertrekKlant.split(':').map(Number);
            const date = new Date();
            date.setHours(h, m - 15); // 15 min eraf

            const newH = String(date.getHours()).padStart(2, '0');
            const newM = String(date.getMinutes()).padStart(2, '0');
            document.getElementById('t-voorstaan').value = `${newH}:${newM}`;
        }

        function rekenUren() {
            const tStart = parseTime(document.getElementById('t-vertrek-zaak').value);
            const tEind = parseTime(document.getElementById('t-aankomst-zaak').value);
            
            if(tStart && tEind) {
                let diff = (tEind - tStart) / (1000 * 60 * 60); // uren
                if(diff < 0) diff += 24; // over middernacht
                document.getElementById('display-uren').innerText = diff.toFixed(2);
                rekenPrijs();
            }
        }

        function parseTime(t) {
            if(!t) return null;
            const [h, m] = t.split(':');
            const d = new Date(); d.setHours(h, m, 0);
            return d;
        }

        function rekenPrijs() {
            const uren = parseFloat(document.getElementById('display-uren').innerText) || 0;
            const kms = parseFloat(document.getElementById('val-km-retour').value) || 0;
            const extra = parseFloat(document.getElementById('kosten-overig').value) || 0;

            const tariefKm = 1.00; 
            const tariefUur = 33.00;
            
            let kostprijs = (kms * tariefKm) + (uren * tariefUur) + extra;
            
            // Winstmarge ~33% (Factor 1.5)
            let verkoopEx = kostprijs * 1.5;
            let totaalIncl = verkoopEx * 1.09;

            // Afronden op 25 euro
            totaalIncl = Math.round(totaalIncl / 25) * 25;

            if(totaalIncl < 200) totaalIncl = 200;

            document.getElementById('eind-totaal').innerText = '€ ' + totaalIncl.toLocaleString('nl-NL', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // --- OPSLAAN & KLANTEN ---
        function toggleNieuweKlant() {
            const el = document.getElementById('nieuw-klant-form');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function slaKlantOp() {
            db.klanten.push({
                id: Date.now(),
                naam: document.getElementById('nk-naam').value,
                plaats: document.getElementById('nk-plaats').value
            });
            saveData();
            toggleNieuweKlant();
        }

        function vulKlantenLijst() {
            const tbody = document.getElementById('klanten-body');
            tbody.innerHTML = '';
            db.klanten.forEach(k => {
                tbody.innerHTML += `<tr><td><b>${k.naam}</b></td><td>${k.plaats}</td><td><button class="btn btn-primary" onclick="kiesKlant('${k.id}')">Kies</button></td></tr>`;
            });
            const select = document.getElementById('calc-klant-select');
            select.innerHTML = '<option value="">-- Kies Klant --</option>';
            db.klanten.forEach(k => { select.innerHTML += `<option value="${k.id}">${k.naam}</option>`; });
        }

        function kiesKlant(id) {
            nav('nieuwe-rit');
            document.getElementById('calc-klant-select').value = id;
        }
        
        function vulKlantInCalc() {
             // Toekomstige logica om klantvelden in te vullen
        }

        function slaRitOp() {
            const klantId = document.getElementById('calc-klant-select').value;
            const klantNaam = klantId ? db.klanten.find(k=>k.id==klantId).naam : 'Onbekend';
            const bus = document.getElementById('bus-type').value;

            db.ritten.unshift({
                id: Date.now(),
                datum: new Date().toLocaleDateString(),
                klant: klantNaam,
                bus: bus,
                bestemming: document.getElementById('route-eind').value,
                bedrag: document.getElementById('eind-totaal').innerText,
                status: 'Offerte'
            });
            saveData();
            nav('dashboard');
        }

        function updateDashboard() {
            document.getElementById('count-klanten').innerText = db.klanten.length;
            document.getElementById('count-offertes').innerText = db.ritten.filter(r => r.status === 'Offerte').length;
            document.getElementById('count-opdrachten').innerText = db.ritten.filter(r => r.status === 'Opdracht').length;
            
            const tbody = document.getElementById('recent-body');
            tbody.innerHTML = '';
            db.ritten.slice(0, 5).forEach(r => {
                tbody.innerHTML += `<tr><td>${r.datum}</td><td><b>${r.klant}</b></td><td>${r.bus}p</td><td>${r.bestemming}</td><td>${r.bedrag}</td><td><span class="status-badge status-${r.status.toLowerCase()}">${r.status}</span></td><td>...</td></tr>`;
            });
        }

        window.onload = initApp;
    </script>
</body>
</html>
