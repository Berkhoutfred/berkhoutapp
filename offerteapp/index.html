<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berkhout Planning V3.5 (Dashboard)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAi1U8gP0dlE87sYaUDI2JbKKFxJW_YjlY&libraries=places&callback=initApp" async defer></script>
    <style>
        :root { --primary: #004a99; --bg: #f3f4f6; --text: #1f2937; --border: #e5e7eb; --success: #10b981; --grey: #d1d5db; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 240px; background: var(--primary); color: white; padding: 25px; display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0,0,0,0.1); z-index: 10; }
        .brand { font-size: 22px; font-weight: 800; margin-bottom: 40px; }
        .nav-item { padding: 14px; cursor: pointer; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-weight: 500; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: white; color: var(--primary); font-weight: 700; }
        
        /* MAIN */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .page-section { display: none; max-width: 1200px; margin: 0 auto; } /* Iets breder voor de tabel */
        .page-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h2 { color: var(--primary); border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 25px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid var(--border); }
        .section-header { font-size: 14px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 15px; }
        
        label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 6px; margin-top: 15px; }
        label:first-of-type { margin-top: 0; }
        
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        input:focus, select:focus { outline: none; border-color: var(--primary); }
        
        /* TABEL STYLING (NIEUW) */
        .rit-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .rit-table th { text-align: left; padding: 12px; background: #f9fafb; border-bottom: 2px solid #e5e7eb; color: #6b7280; font-weight: 700; text-transform: uppercase; font-size: 12px; }
        .rit-table td { padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .rit-table tr:hover { background: #f9fafb; }
        
        .status-icon { font-size: 18px; cursor: pointer; color: var(--grey); transition: 0.2s; padding: 5px; }
        .status-icon:hover { transform: scale(1.2); }
        .status-icon.done { color: var(--success); }
        
        .status-header { text-align: center !important; width: 60px; font-size: 10px; }
        .status-cell { text-align: center; }

        /* OVERIGE STYLES (CALCULATIE) */
        .bus-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .bus-option { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .bus-option:hover { background: #eff6ff; border-color: var(--primary); }
        .bus-option input { width: auto; margin: 0; }

        .time-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; background: #fff; border-radius: 6px; margin-bottom: 6px; border: 1px solid #e5e7eb; }
        .time-select-group { display: flex; gap: 4px; align-items: center; }
        .select-uur, .select-min { width: 50px; padding: 5px; text-align: center; font-weight: 600; border-radius: 4px; border: 1px solid #d1d5db; cursor: pointer; background: white; }
        .select-uur:hover, .select-min:hover { border-color: var(--primary); }
        
        .highlight-time { border-left: 3px solid #10b981; background:#f0fdf4; } 
        .rit-divider { background: #eef6ff; color: var(--primary); font-weight: bold; padding: 8px; border-radius: 6px; margin: 15px 0 5px 0; font-size: 13px; text-align: center; border: 1px dashed var(--primary); }

        .total-box { background: var(--primary); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px; }
        .total-price { font-size: 32px; font-weight: 800; margin: 5px 0; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 15px; }
        .btn-green { background: #10b981; color: white; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-link { background: none; color: var(--primary); width: auto; padding: 0; font-size: 13px; margin-top: 5px; text-decoration: underline; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fa-solid fa-bus"></i> BERKHOUT</div>
    <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-list-check"></i> Ritoverzicht</div>
    <div class="nav-item" onclick="nav('calculatie')"><i class="fa-solid fa-calculator"></i> Calculatie</div>
    <div class="nav-item" onclick="nav('klanten')"><i class="fa-solid fa-users"></i> Klanten</div>
</div>

<div class="main">

    <div id="dashboard" class="page-section active">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; border:none;">Ritoverzicht</h2>
            <button class="btn-blue" style="width:auto; padding:10px 20px;" onclick="nav('calculatie')">+ Nieuwe Rit</button>
        </div>

        <div class="card" style="padding:0; overflow:hidden;">
            <table class="rit-table">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Klant</th>
                        <th>Bestemming</th>
                        <th>Type</th>
                        <th>Prijs</th>
                        <th class="status-header">Offerte</th>
                        <th class="status-header">Bevest.</th>
                        <th class="status-header">Opdracht</th>
                        <th class="status-header">Factuur</th>
                        <th class="status-header">Betaald</th>
                    </tr>
                </thead>
                <tbody id="rit-tabel-body">
                    </tbody>
            </table>
            <div id="empty-state" style="padding:40px; text-align:center; color:#999; display:none;">
                Nog geen ritten in het systeem.
            </div>
        </div>
    </div>

    <div id="calculatie" class="page-section">
        <h2>Nieuwe Offerte</h2>
        
        <div class="grid-2">
            <div>
                <div class="card">
                    <div class="section-header">1. Klant & Voertuig</div>
                    <select id="calc-klant" onchange="vulKlant()"><option value="">-- Selecteer Klant --</option></select>
                    <div id="klant-details" style="display:none; background:#f0f9ff; padding:10px; border-radius:6px; margin-top:10px; font-size:13px; color:#0369a1;"></div>
                    <label>Kies Voertuig(en)</label>
                    <div class="bus-grid" id="bus-container"></div>
                </div>

                <div class="card">
                    <div class="section-header">2. Route</div>
                    <label>Vertrek Garage</label>
                    <input type="text" id="route-start" value="Industrieweg 99J, Zutphen">
                    <label>Ophaaladres</label>
                    <input type="text" id="route-ophaal" placeholder="Zoek adres..." onchange="berekenRoute()">
                    <button class="btn-link" onclick="toggleVia()">+ Via-locatie</button>
                    <div id="via-container" class="hidden">
                        <label>Via 1</label>
                        <input type="text" id="route-via1" onchange="berekenRoute()">
                        <label>Via 2</label>
                        <input type="text" id="route-via2" onchange="berekenRoute()">
                    </div>
                    <label>Bestemming</label>
                    <input type="text" id="route-eind" placeholder="Zoek bestemming..." onchange="berekenRoute()">
                    
                    <div style="background:#eff6ff; border:1px solid #bfdbfe; padding:15px; border-radius:8px; margin-top:15px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px;">
                            <span>Aanrijtijd (G-K):</span><span style="font-weight:bold; color:var(--primary);" id="info-aanrij">-</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px;">
                            <span>Rijtijd (K-B):</span><span style="font-weight:bold; color:var(--primary);" id="info-rit">-</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:16px; font-weight:bold; border-top:1px dashed #bfdbfe; padding-top:10px; margin-top:5px;">
                            <span>Afstand (Calculatie):</span><span style="color:var(--primary);" id="info-totaal">0 km</span>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="card">
                    <div class="section-header">3. Tijdsplanning & Type</div>
                    
                    <label style="color:var(--primary);">Type Rit</label>
                    <select id="rit-type" onchange="wisselTijdLijst()" style="font-weight:bold; border:2px solid var(--primary); margin-bottom:15px;">
                        <option value="enkel">Enkele Rit (Brengen)</option>
                        <option value="vv" selected>Dagtocht (Volledig)</option>
                        <option value="brenghaal">Breng & Haal (Gesplitst)</option>
                    </select>

                    <div id="tijd-standaard"></div>
                    <div id="tijd-brenghaal" class="hidden">
                        <div class="rit-divider">DEEL 1: BRENGEN</div>
                        <div id="bh-deel1"></div>
                        <div class="rit-divider">DEEL 2: HALEN</div>
                        <div id="bh-deel2"></div>
                    </div>
                    
                    <div style="text-align:right; font-weight:bold; margin-top:15px; color:var(--primary); font-size:18px;">
                        Facturabele Uren: <span id="uren-display">0.0</span> uur
                    </div>
                    <div style="text-align:right; font-size:12px; color:#666; font-style:italic;" id="uren-uitleg">
                        Gebaseerd op planning
                    </div>
                </div>

                <div class="card">
                    <div class="section-header">4. Prijs</div>
                    <label>Extra Kosten</label>
                    <input type="number" id="kosten-extra" value="0" placeholder="€ 0.00" oninput="rekenPrijs()">
                    
                    <div class="total-box">
                        <div style="font-size:14px; opacity:0.9;">Totaal incl. 9% BTW</div>
                        <div class="total-price" id="prijs-display">€ 0,00</div>
                        <div style="font-size:13px; opacity:0.9;" id="btw-display">BTW: € 0,00</div>
                    </div>
                    
                    <button class="btn btn-green" onclick="opslaan()"><i class="fa-solid fa-save"></i> Opslaan & Offerte Maken</button>
                </div>
            </div>
        </div>
    </div>

    <div id="klanten" class="page-section">
        <h2>Klantenbestand</h2>
        <div class="card">
            <div class="section-header">Nieuwe Klant</div>
            <label>Zoek Bedrijf (Google)</label>
            <input type="text" id="zoek-bedrijf" placeholder="Typ bedrijfsnaam...">
            <div class="grid-2">
                <div><label>Naam</label><input type="text" id="nk-naam"></div>
                <div><label>Adres</label><input type="text" id="nk-adres"></div>
                <div><label>Tel</label><input type="text" id="nk-tel"></div>
                <div><label>Plaats</label><input type="text" id="nk-plaats"></div>
            </div>
            <button class="btn btn-green" onclick="klantOpslaan()">Toevoegen</button>
        </div>
        <div class="card">
            <div class="section-header">Bestaande Klanten</div>
            <div id="klanten-lijst"></div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATIE ---
    let db = { klanten: [], ritten: [] };
    let enkeleReisKM = 0; 
    let enkeleReisSec = 0; 
    let aanrijSec = 0;
    let ritSec = 0; 

    const busOpties = [
        { label: 'Bus 19', prijs: 0.75 }, { label: 'Bus 23', prijs: 0.75 },
        { label: 'Bus 50', prijs: 1.00 }, { label: 'Bus 55', prijs: 1.00 },
        { label: 'Bus 60', prijs: 1.20 }, { label: 'Bus 62', prijs: 1.20 }
    ];

    // DEFINITIE TIJDSLIJSTEN (EXACT V3.4)
    const tijdVeldenStandaard = [
        { id: 'std_1', label: '1. Vertrek Garage', defH: '08', defM: '00' },
        { id: 'std_2', label: '2. Voorstaan', defH: '08', defM: '30' },
        { id: 'std_3', label: '3. Vertrek Klant', defH: '08', defM: '45', trigger: true, style: 'highlight-time' },
        { id: 'std_4', label: '4. Aankomst Loc.', defH: '10', defM: '00' },
        { id: 'std_5', label: '5. Vertrek Loc.', defH: '16', defM: '00' },
        { id: 'std_6', label: '6. Retour Klant', defH: '17', defM: '15', trigger: true, style: 'highlight-time' },
        { id: 'std_7', label: '7. Aankomst Garage', defH: '18', defM: '00' }
    ];
    const tijdVeldenBrengen = [
        { id: 'br_1', label: '1. Vertrek Garage', defH: '12', defM: '15' },
        { id: 'br_2', label: '2. Voorstaan', defH: '12', defM: '45' },
        { id: 'br_3', label: '3. Vertrek Klant', defH: '13', defM: '00', trigger: true, style: 'highlight-time' },
        { id: 'br_4', label: '4. Aankomst Best.', defH: '13', defM: '45' },
        { id: 'br_5', label: '5. Retour Garage', defH: '14', defM: '30' }
    ];
    const tijdVeldenHalen = [
        { id: 'hl_1', label: '1. Vertrek Garage', defH: '17', defM: '15' },
        { id: 'hl_2', label: '2. Voorstaan Best.', defH: '17', defM: '45' },
        { id: 'hl_3', label: '3. Vertrek Best.', defH: '18', defM: '00', trigger: true, style: 'highlight-time' },
        { id: 'hl_4', label: '4. Aankomst Klant', defH: '18', defM: '45' },
        { id: 'hl_5', label: '5. Retour Garage', defH: '19', defM: '15' }
    ];

    // --- 2. INIT ---
    window.initApp = function() {
        const save = localStorage.getItem('berkhout_v2');
        if(save) db = JSON.parse(save);
        
        bouwBusKiezers();
        bouwTijdLijsten();
        updateKlantenLijst();
        updateDashboard(); // Nu de nieuwe tabel functie
        initMapsAutofill();
        wisselTijdLijst(); 
        rekenUren();
    }

    // --- 3. DASHBOARD LOGICA (NIEUW) ---
    function updateDashboard() {
        const tbody = document.getElementById('rit-tabel-body');
        const empty = document.getElementById('empty-state');
        tbody.innerHTML = '';

        if(db.ritten.length === 0) {
            empty.style.display = 'block';
            return;
        }
        empty.style.display = 'none';

        db.ritten.forEach((rit, index) => {
            // Zorg dat status object bestaat (voor oude data)
            if(!rit.status) rit.status = { offerte: true, bevestiging: false, opdracht: false, factuur: false, betaald: false };
            
            let tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold;">${rit.datum}</td>
                <td>${rit.klant}</td>
                <td>${rit.dest || '-'}</td>
                <td><span style="background:#eef6ff; color:#004a99; padding:3px 8px; border-radius:10px; font-size:11px;">${rit.type || 'Dagtocht'}</span></td>
                <td style="font-weight:bold;">${rit.prijs}</td>
                
                <td class="status-cell" onclick="toggleStatus(${index}, 'offerte')">
                    <i class="fa-solid fa-circle-check status-icon ${rit.status.offerte ? 'done' : ''}"></i>
                </td>
                <td class="status-cell" onclick="toggleStatus(${index}, 'bevestiging')">
                    <i class="fa-solid fa-circle-check status-icon ${rit.status.bevestiging ? 'done' : ''}"></i>
                </td>
                <td class="status-cell" onclick="toggleStatus(${index}, 'opdracht')">
                    <i class="fa-solid fa-circle-check status-icon ${rit.status.opdracht ? 'done' : ''}"></i>
                </td>
                <td class="status-cell" onclick="toggleStatus(${index}, 'factuur')">
                    <i class="fa-solid fa-circle-check status-icon ${rit.status.factuur ? 'done' : ''}"></i>
                </td>
                <td class="status-cell" onclick="toggleStatus(${index}, 'betaald')">
                    <i class="fa-solid fa-circle-check status-icon ${rit.status.betaald ? 'done' : ''}"></i>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function toggleStatus(index, veld) {
        // Toggle de waarde
        db.ritten[index].status[veld] = !db.ritten[index].status[veld];
        
        // Opslaan en verversen
        localStorage.setItem('berkhout_v2', JSON.stringify(db));
        updateDashboard();
    }

    // --- 4. UI BOUWERS ---
    function bouwBusKiezers() {
        const c = document.getElementById('bus-container');
        let h = '';
        busOpties.forEach((b, i) => {
            h += `<label class="bus-option"><input type="checkbox" class="bus-check" value="${i}" onchange="rekenPrijs()"><span><b>${b.label}</b><br><small>€${b.prijs.toFixed(2)}/km</small></span></label>`;
        });
        c.innerHTML = h;
    }

    function maakTijdRij(veld) {
        let uO = '', mO = '';
        for(let i=0; i<24; i++) { let val=i.toString().padStart(2,'0'); uO+=`<option value="${val}" ${val==veld.defH?'selected':''}>${val}</option>`; }
        ['00','15','30','45'].forEach(m => { mO+=`<option value="${m}" ${m==veld.defM?'selected':''}>${m}</option>`; });
        let changeFn = veld.trigger ? `syncTijden(); rekenUren()` : `rekenUren()`;
        return `<div id="row_${veld.id}" class="time-row ${veld.style || ''}"><div style="font-size:12px; width:110px;">${veld.label}</div><div class="time-select-group"><select id="h_${veld.id}" class="select-uur" onchange="${changeFn}">${uO}</select>:<select id="m_${veld.id}" class="select-min" onchange="${changeFn}">${mO}</select></div></div>`;
    }

    function bouwTijdLijsten() {
        let hStd = ''; tijdVeldenStandaard.forEach(v => hStd += maakTijdRij(v)); document.getElementById('tijd-standaard').innerHTML = hStd;
        let hBr = ''; tijdVeldenBrengen.forEach(v => hBr += maakTijdRij(v)); document.getElementById('bh-deel1').innerHTML = hBr;
        let hHl = ''; tijdVeldenHalen.forEach(v => hHl += maakTijdRij(v)); document.getElementById('bh-deel2').innerHTML = hHl;
    }

    function nav(id) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    function toggleVia() { document.getElementById('via-container').classList.toggle('hidden'); }

    // --- 5. LOGICA (V3.4 ONGEWIJZIGD) ---
    function wisselTijdLijst() {
        const type = document.getElementById('rit-type').value;
        const contStd = document.getElementById('tijd-standaard');
        const contBH = document.getElementById('tijd-brenghaal');
        if(type === 'brenghaal') {
            contStd.classList.add('hidden'); contBH.classList.remove('hidden');
        } else {
            contStd.classList.remove('hidden'); contBH.classList.add('hidden');
            const rows = {'std_2':document.getElementById('row_std_2'),'std_5':document.getElementById('row_std_5'),'std_6':document.getElementById('row_std_6')};
            for(let k in rows) if(rows[k]) rows[k].classList.remove('hidden');
            if(type === 'enkel') {
                if(rows['std_2']) rows['std_2'].classList.add('hidden');
                if(rows['std_5']) rows['std_5'].classList.add('hidden');
                if(rows['std_6']) rows['std_6'].classList.add('hidden');
            }
        }
        rekenUren();
    }
    
    function getTijd(id) {
        const elH = document.getElementById('h_'+id); const elM = document.getElementById('m_'+id);
        if(!elH || !elM) return new Date(2000,0,1,0,0);
        return new Date(2000, 0, 1, parseInt(elH.value), parseInt(elM.value));
    }
    function setTijd(id, date) {
        const elH = document.getElementById('h_'+id); const elM = document.getElementById('m_'+id);
        if(elH && elM) { elH.value = date.getHours().toString().padStart(2,'0'); elM.value = date.getMinutes().toString().padStart(2,'0'); }
    }

    function syncTijden() {
        const type = document.getElementById('rit-type').value;
        let tAanrij = (aanrijSec > 0) ? (aanrijSec * 1000) : (15 * 60000);
        let tRit = (ritSec > 0) ? (ritSec * 1000) : (30 * 60000);
        let tTotaal = tAanrij + tRit;

        if(type === 'brenghaal') {
            let dVertrek = getTijd('br_3');
            let dVoorstaan = new Date(dVertrek.getTime() - (15*60000)); setTijd('br_2', dVoorstaan);
            let dGarageWeg = new Date(dVoorstaan.getTime() - tAanrij); setTijd('br_1', dGarageWeg);
            let dAankomst = new Date(dVertrek.getTime() + tRit); setTijd('br_4', dAankomst);
            let dGarageThuis = new Date(dAankomst.getTime() + tTotaal); setTijd('br_5', dGarageThuis);

            let dVertrekBest = getTijd('hl_3');
            let dVoorstaanBest = new Date(dVertrekBest.getTime() - (15*60000)); setTijd('hl_2', dVoorstaanBest);
            let dGarageWeg2 = new Date(dVoorstaanBest.getTime() - tTotaal); setTijd('hl_1', dGarageWeg2);
            let dAankomstKlant = new Date(dVertrekBest.getTime() + tRit); setTijd('hl_4', dAankomstKlant);
            let dGarageThuis2 = new Date(dAankomstKlant.getTime() + tAanrij); setTijd('hl_5', dGarageThuis2);
        } else {
            let dVertrekKlant = getTijd('std_3');
            let dVoorstaan = new Date(dVertrekKlant.getTime() - (15*60000)); setTijd('std_2', dVoorstaan);
            let dVertrekZaak = new Date(dVoorstaan.getTime() - tAanrij); setTijd('std_1', dVertrekZaak);
            let dRetourKlant = getTijd('std_6');
            if(type === 'enkel') {
                let dAankomstLoc = getTijd('std_4');
                if(ritSec > 0) { dAankomstLoc = new Date(dVertrekKlant.getTime() + tRit); setTijd('std_4', dAankomstLoc); }
                let dAankomstZaak = new Date(dAankomstLoc.getTime() + tTotaal); setTijd('std_7', dAankomstZaak);
            } else {
                let dAankomstZaak = new Date(dRetourKlant.getTime() + tAanrij); setTijd('std_7', dAankomstZaak);
            }
        }
    }

    function rekenUren() {
        const type = document.getElementById('rit-type').value;
        const uitleg = document.getElementById('uren-uitleg');
        const kmDisplay = document.getElementById('info-totaal');
        let uren = 0; let totaalKM = 0;

        if (type === 'brenghaal') {
            let d1_s = getTijd('br_1'); let d1_e = getTijd('br_5');
            let diff1 = (d1_e - d1_s)/3600000; if(diff1<0) diff1+=24;
            let d2_s = getTijd('hl_1'); let d2_e = getTijd('hl_5');
            let diff2 = (d2_e - d2_s)/3600000; if(diff2<0) diff2+=24;
            uren = diff1 + diff2; uitleg.innerText = `Brengen (${diff1.toFixed(2)}u) + Halen (${diff2.toFixed(2)}u)`;
            totaalKM = enkeleReisKM * 4; kmDisplay.innerText = `${totaalKM} km (2x Retour)`;
        } else {
            let dS = getTijd('std_1'); let dE = getTijd('std_7');
            let diff = (dE - dS)/3600000; if(diff<0) diff+=24;
            uren = diff; uitleg.innerText = "Totaal dagtocht (Garage ➔ Garage)";
            totaalKM = enkeleReisKM * 2; kmDisplay.innerText = `${totaalKM} km (Retour)`;
        }
        if(isNaN(uren)) uren = 0;
        document.getElementById('uren-display').innerText = uren.toFixed(2);
        window.berekendeTotaalKM = totaalKM;
        rekenPrijs();
    }

    function rekenPrijs() {
        const uren = parseFloat(document.getElementById('uren-display').innerText) || 0;
        const extra = parseFloat(document.getElementById('kosten-extra').value) || 0;
        const kms = window.berekendeTotaalKM || 0;
        let kmTarief = 0; let bussen = 0;
        document.querySelectorAll('.bus-check').forEach(b => { if(b.checked) { kmTarief += busOpties[b.value].prijs; bussen++; } });
        if (bussen === 0) { document.getElementById('prijs-display').innerText = '€ 0,00'; return; }
        
        let kostprijs = (kms * kmTarief) + (uren * 33.00 * bussen) + extra;
        let verkoopEx = kostprijs / 0.75; let verkoopIncl = verkoopEx * 1.09;
        let eind = Math.ceil(verkoopIncl / 25) * 25; if(eind < 200) eind = 200;
        let exBtw = eind / 1.09; let btw = eind - exBtw;

        document.getElementById('prijs-display').innerText = '€ ' + eind.toLocaleString('nl-NL', {minimumFractionDigits: 2});
        document.getElementById('btw-display').innerText = 'BTW (9%): € ' + btw.toLocaleString('nl-NL', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // --- 6. OPSLAAN & MAPS (UPDATED) ---
    function opslaan() {
        let typeText = 'Dagtocht';
        const tv = document.getElementById('rit-type').value;
        if(tv === 'enkel') typeText = 'Enkele rit';
        if(tv === 'brenghaal') typeText = 'Breng & Haal';

        db.ritten.unshift({
            datum: new Date().toLocaleDateString('nl-NL'),
            klant: document.getElementById('calc-klant').selectedOptions[0].text,
            dest: document.getElementById('route-eind').value,
            prijs: document.getElementById('prijs-display').innerText,
            type: typeText,
            // NIEUW: Status object voor de vinkjes
            status: { offerte: true, bevestiging: false, opdracht: false, factuur: false, betaald: false }
        });
        localStorage.setItem('berkhout_v2', JSON.stringify(db));
        updateDashboard();
        alert('Rit opgeslagen! Ga naar het Ritoverzicht om de status te beheren.');
    }

    // Maps & Klant Functies (ongewijzigd)
    function initMapsAutofill() { const o={componentRestrictions:{country:'nl'}}; ['route-start','route-ophaal','route-eind','route-via1','route-via2'].forEach(id=>{ const el=document.getElementById(id); if(el) new google.maps.places.Autocomplete(el,o).addListener('place_changed',berekenRoute); }); const z=document.getElementById('zoek-bedrijf'); if(z) new google.maps.places.Autocomplete(z,o).addListener('place_changed',function(){ const p=this.getPlace(); document.getElementById('nk-naam').value=p.name||''; document.getElementById('nk-tel').value=p.formatted_phone_number||''; document.getElementById('nk-adres').value=p.formatted_address||''; let s=''; if(p.address_components) p.address_components.forEach(c=>{if(c.types.includes('locality'))s=c.long_name}); document.getElementById('nk-plaats').value=s; }); }
    function berekenRoute() { const start=document.getElementById('route-start').value; const ophaal=document.getElementById('route-ophaal').value; const eind=document.getElementById('route-eind').value; if(!start||!ophaal||!eind)return; const w=[{location:ophaal,stopover:true}]; if(document.getElementById('route-via1').value) w.push({location:document.getElementById('route-via1').value,stopover:true}); if(document.getElementById('route-via2').value) w.push({location:document.getElementById('route-via2').value,stopover:true}); const ds=new google.maps.DirectionsService(); ds.route({origin:start,destination:eind,waypoints:w,travelMode:'DRIVING'},(res,status)=>{ if(status==='OK'){ const legs=res.routes[0].legs; aanrijSec=legs[0].duration.value; let rd=0;let td=0; legs.forEach((l,i)=>{ td+=l.distance.value; if(i>0) rd+=l.duration.value; }); ritSec=rd; enkeleReisKM=Math.round(td/1000); enkeleReisSec=aanrijSec+ritSec; document.getElementById('info-aanrij').innerText=`${Math.round(aanrijSec/60)} min`; document.getElementById('info-rit').innerText=`${Math.round(ritSec/60)} min`; syncTijden(); rekenUren(); }}); }
    function vulKlant() { const id=document.getElementById('calc-klant').value; const k=db.klanten.find(x=>x.id==id); const d=document.getElementById('klant-details'); if(k){ document.getElementById('route-ophaal').value=k.adres||k.plaats; d.style.display='block'; d.innerHTML=`<b>${k.naam}</b><br>${k.adres}, ${k.plaats}`; berekenRoute(); }else d.style.display='none'; }
    function klantOpslaan() { db.klanten.push({id:Date.now(),naam:document.getElementById('nk-naam').value,adres:document.getElementById('nk-adres').value,plaats:document.getElementById('nk-plaats').value,tel:document.getElementById('nk-tel').value}); localStorage.setItem('berkhout_v2',JSON.stringify(db)); updateKlantenLijst(); nav('klanten'); ['nk-naam','nk-adres','nk-plaats','nk-tel','zoek-bedrijf'].forEach(i=>document.getElementById(i).value=''); }
    function updateKlantenLijst() { const s=document.getElementById('calc-klant'); s.innerHTML='<option value="">-- Kies Klant --</option>'; let h='<table style="width:100%;text-align:left;border-collapse:collapse;"><tr><th>Naam</th><th>Plaats</th></tr>'; db.klanten.forEach(k=>{ s.innerHTML+=`<option value="${k.id}">${k.naam}</option>`; h+=`<tr><td style="border-bottom:1px solid #eee;padding:5px;">${k.naam}</td><td style="border-bottom:1px solid #eee;">${k.plaats}</td></tr>`; }); document.getElementById('klanten-lijst').innerHTML=h+'</table>'; }
</script>
</body>
</html>
