<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berkhout Totaal Systeem V3.19</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAi1U8gP0dlE87sYaUDI2JbKKFxJW_YjlY&libraries=places&callback=initApp" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- BASIS STIJL (V3.16/3.18) --- */
        :root { --primary: #004a99; --bg: #f3f4f6; --text: #1f2937; --border: #e5e7eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 240px; background: var(--primary); color: white; padding: 25px; display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0,0,0,0.1); z-index: 10; }
        .brand { font-size: 20px; font-weight: 800; margin-bottom: 40px; letter-spacing: 1px; }
        .nav-item { padding: 14px; cursor: pointer; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-weight: 500; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: white; color: var(--primary); font-weight: 700; }
        
        .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        .page-section { display: none; max-width: 1400px; margin: 0 auto; }
        .page-section.active { display: block; animation: fadeIn 0.3s ease; }
        
        /* KAARTEN & ELEMENTEN */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid var(--border); }
        h2 { color: var(--primary); border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 25px; }
        h3 { font-size: 15px; color: var(--primary); margin: 15px 0 10px 0; border-bottom: 1px dashed #ccc; padding-bottom: 5px; font-weight: 700; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        
        /* FORMULIEREN */
        label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 5px; margin-top: 15px; }
        label:first-of-type { margin-top: 0; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        input:focus { border-color: var(--primary); outline: none; }
        
        /* ZOEKBALK MET AUTOCOMPLETE UI */
        .search-wrapper { position: relative; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--primary); border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; }
        .search-item:hover { background: #f0f9ff; }

        /* TABELLEN */
        .rit-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .rit-table th { text-align: left; padding: 12px 10px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; color: #64748b; font-weight: 700; text-transform: uppercase; font-size: 11px; }
        .rit-table td { padding: 12px 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .rit-table tr:hover { background: #f8fafc; }
        
        /* STATUS ICONS */
        .status-header { text-align: center !important; width: 45px; font-size: 9px; }
        .status-cell { text-align: center; }
        .status-icon { font-size: 16px; cursor: pointer; color: #e2e8f0; transition: 0.2s; }
        .status-icon:hover { transform: scale(1.1); color: #cbd5e1; }
        .status-icon.done { color: var(--success); }
        .status-icon.active-action { color: var(--warning); transform: scale(1.2); }

        /* BUTTONS */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 15px; font-size: 14px; transition: 0.2s; }
        .btn-green { background: #10b981; color: white; } .btn-green:hover { background: #059669; }
        .btn-blue { background: var(--primary); color: white; } .btn-blue:hover { background: #003d80; }
        .btn-grey { background: #64748b; color: white; }
        .btn-icon { width: 32px; height: 32px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; color: #64748b; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon:hover { border-color: var(--primary); color: var(--primary); }

        /* TIJDEN & BUSSEN */
        .bus-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .bus-option { display: flex; align-items: center; gap: 10px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; cursor: pointer; }
        .bus-option:hover { background: #f0f9ff; border-color: var(--primary); }
        .bus-option input { width: auto; margin: 0; }
        
        .time-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; background: #fff; border-radius: 6px; margin-bottom: 6px; border: 1px solid #e5e7eb; }
        .time-select-group { display: flex; gap: 4px; align-items: center; }
        .select-uur, .select-min { width: 45px; padding: 4px; text-align: center; font-weight: 600; border-radius: 4px; border: 1px solid #d1d5db; background: white; font-size: 13px; }
        .rit-divider { background: #e0f2fe; color: #0369a1; font-weight: 700; padding: 6px; border-radius: 4px; margin: 15px 0 5px 0; font-size: 11px; text-align: center; letter-spacing: 0.5px; }

        /* TOTALEN & WINST */
        .total-box { background: var(--primary); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px; }
        .total-price { font-size: 28px; font-weight: 800; margin: 5px 0; }
        .profit-box { margin-top:10px; padding:10px; background:#ecfdf5; border-radius:8px; border:1px solid #10b981; text-align:center; }
        .profit-amount { font-size:20px; font-weight:800; color:#047857; }

        /* MODAL (PDF PREVIEW) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: #475569; width: 1100px; max-width: 95%; max-height: 95vh; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-header { background: #1e293b; color: white; padding: 15px 25px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        .modal-body { padding: 30px; overflow-y: auto; background: #475569; display: flex; justify-content: center; }
        .modal-footer { padding: 15px 25px; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 10px; }

        /* --- PDF PAPIER STIJL (EXACTE KOPIE) --- */
        .pdf-container {
            width: 794px; /* Exacte A4 breedte in pixels bij 96 DPI om afsnijden te voorkomen */
            min-height: 1123px;
            padding: 40px 50px;
            background: white; 
            color: #000; 
            font-family: 'Arial', sans-serif; /* Standaard font voor offertes */
            font-size: 13px; 
            line-height: 1.4;
            box-sizing: border-box;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        
        /* PDF Layout Classes */
        .pdf-logo { font-size: 26px; font-weight: bold; color: #000; margin-bottom: 5px; } /* Zwart zoals voorbeeld? Of Blauw? Ik hou blauw voor Berkhout */
        .pdf-logo { color: #004a99; }
        
        .pdf-header-row { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .pdf-sender { font-size: 12px; line-height: 1.4; }
        .pdf-receiver { margin-top: 20px; font-size: 14px; font-weight: bold; line-height: 1.4; }
        .pdf-meta { text-align: right; font-size: 12px; }
        
        .pdf-slogan { font-size: 14px; font-weight: bold; color: #004a99; margin-bottom: 15px; font-style: italic; }
        
        .pdf-subject { font-size: 16px; font-weight: bold; margin: 25px 0 15px 0; border-bottom: 1px solid #000; padding-bottom: 5px; display: inline-block; width: 100%; }
        
        /* De tabellen exact namaken */
        .pdf-grid-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px; }
        .pdf-grid-table td { padding: 4px 0; vertical-align: top; }
        .pdf-label-col { width: 160px; font-weight: bold; }
        .pdf-val-col { }

        .pdf-money-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #000; }
        .pdf-money-table th { background: #f0f0f0; padding: 8px; text-align: left; border-bottom: 1px solid #000; font-weight: bold; }
        .pdf-money-table td { padding: 8px; border-bottom: 1px solid #ccc; }
        .pdf-money-total { border-top: 2px solid #000; font-weight: bold; font-size: 14px; }

        .pdf-footer { margin-top: 40px; font-size: 11px; text-align: justify; color: #333; border-top: 1px solid #ccc; padding-top: 10px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fa-solid fa-bus"></i> BERKHOUT</div>
    <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-layer-group"></i> Overzicht</div>
    <div class="nav-item" onclick="nav('calculatie')"><i class="fa-solid fa-calculator"></i> Nieuwe Rit</div>
    <div class="nav-item" onclick="nav('klanten')"><i class="fa-solid fa-users"></i> Klanten (CRM)</div>
</div>

<div class="main">

    <div id="dashboard" class="page-section active">
        <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:15px 25px;">
             <div class="year-selector">
                <button class="btn-icon" onclick="changeYear(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="display-year" style="font-size:18px; font-weight:bold; margin:0 15px; color:var(--primary);">2026</span>
                <button class="btn-icon" onclick="changeYear(1)"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <div class="month-grid" id="month-buttons"></div>
        </div>

        <div class="card" style="padding:0; overflow:hidden;">
            <table class="rit-table">
                <thead>
                    <tr>
                        <th style="width:50px;"></th>
                        <th style="width:100px;">Datum</th>
                        <th>Klant & Rit</th>
                        <th style="text-align:right;">Prijs</th>
                        <th class="status-header" title="Offerte Verstuurd">OFF</th>
                        <th class="status-header" title="Bevestigd door Klant">BEV</th>
                        <th class="status-header" title="Ritopdracht naar Chauffeur">RIT</th>
                        <th class="status-header" title="Gefactureerd">FAC</th>
                    </tr>
                </thead>
                <tbody id="rit-tabel-body"></tbody>
            </table>
            <div id="empty-state" style="padding:50px; text-align:center; color:#94a3b8; font-style:italic;">Nog geen ritten in deze periode.</div>
        </div>
    </div>

    <div id="calculatie" class="page-section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="calc-title">Nieuwe Aanvraag</h2>
            <button onclick="resetForm()" style="background:none; border:none; color:#64748b; cursor:pointer;"><i class="fa-solid fa-rotate-left"></i> Reset</button>
        </div>

        <div class="grid-2">
            <div>
                <div class="card">
                    <div class="section-header">1. Klant & Datum</div>
                    <div style="display:flex; gap:15px; margin-bottom:15px;">
                        <div style="flex:1;"><label>Vertrekdatum</label><input type="date" id="rit_datum" onchange="syncDates()"></div>
                        <div style="flex:1;"><label>Einddatum</label><input type="date" id="rit_datum_eind" onchange="rekenUren()"></div>
                    </div>
                    
                    <label>Klant Zoeken</label>
                    <div class="search-wrapper">
                        <input type="text" id="calc-klant-zoek" placeholder="Typ bedrijfsnaam of plaats..." oninput="filterCalcClients()">
                        <input type="hidden" id="calc-klant-id">
                        <div class="search-results" id="calc-klant-results"></div>
                    </div>

                    <label>Contactpersoon</label>
                    <select id="calc-contact"><option value="">-- Kies eerst een klant --</option></select>

                    <div id="klant-details" style="display:none; background:#f0f9ff; padding:10px; border-radius:6px; margin-top:10px; font-size:12px; color:#0369a1; border:1px solid #bae6fd;"></div>
                    
                    <div style="display:flex; gap:15px; margin-top:10px;">
                        <div style="flex:1;"><label>Aantal Pax</label><input type="number" id="calc-pax" value="50"></div>
                        <div style="flex:1;"><label>Aantal Bussen</label><input type="number" id="calc-bus-count" value="1" readonly style="background:#f1f5f9;"></div>
                    </div>

                    <label>Voertuig Selectie</label>
                    <div class="bus-grid" id="bus-container"></div>
                </div>

                <div class="card">
                    <div class="section-header">2. Route & Google Maps</div>
                    <label>Start Garage</label><input type="text" id="route-start" value="Industrieweg 95A, Zutphen">
                    
                    <label>Ophaaladres</label><input type="text" id="route-ophaal" placeholder="Zoek adres..." onchange="berekenRoute()">
                    
                    <div id="via-container" class="hidden" style="margin-top:5px; padding-left:10px; border-left:2px solid #e2e8f0;">
                         <label>Via 1</label><input type="text" id="route-via1" onchange="berekenRoute()">
                         <label>Via 2</label><input type="text" id="route-via2" onchange="berekenRoute()">
                    </div>
                    <button class="btn-link" onclick="toggleVia()" style="margin-bottom:10px;">+ Via toevoegen</button>

                    <label>Bestemming</label><input type="text" id="route-eind" placeholder="Zoek bestemming..." onchange="berekenRoute()">
                    
                    <div style="background:#f8fafc; border:1px solid #e2e8f0; padding:15px; border-radius:8px; margin-top:15px;">
                        <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:5px;">
                            <span>Reistijd (Enkel):</span><strong id="info-rit" style="color:var(--primary);">-</strong>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:5px;">
                            <span>Aanrijtijd:</span><strong id="info-aanrij" style="color:#64748b;">-</strong>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:15px; font-weight:bold; border-top:1px dashed #cbd5e1; padding-top:8px; margin-top:5px;">
                            <span>Totaal KM:</span><span id="info-totaal" style="color:var(--primary);">0 km</span>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="card">
                    <div class="section-header">3. Planning & Tijden</div>
                    <select id="rit-type" onchange="wisselTijdLijst()" style="font-weight:bold; border:2px solid var(--primary); padding:10px; margin-bottom:15px;">
                        <option value="vv" selected>Dagtocht (Volledig)</option>
                        <option value="enkel">Enkele Rit (Transfer)</option>
                        <option value="brenghaal">Breng & Haal (Gesplitst)</option>
                        <option value="meerdaagse">Meerdaagse Reis</option>
                    </select>

                    <div id="tijd-container"></div>
                    
                    <div style="text-align:right; margin-top:15px;">
                        <span style="font-size:12px; color:#64748b;">Gecarruleerde inzet:</span><br>
                        <span id="uren-display" style="font-size:20px; font-weight:800; color:var(--primary);">0.00</span> <span style="font-weight:bold;">uur</span>
                    </div>
                </div>

                <div class="card">
                    <div class="section-header">4. Calculatie</div>
                    <label>Overige Kosten (Tol, Parkeren)</label>
                    <input type="number" id="kosten-extra" value="0" oninput="rekenPrijs()">

                    <div class="total-box">
                        <div style="font-size:13px; opacity:0.8;">Totaal incl. 9% BTW</div>
                        <div class="total-price" id="prijs-display">€ 0,00</div>
                        <div style="font-size:13px; opacity:0.8;" id="btw-display">BTW: € 0,00</div>
                    </div>

                    <div class="profit-box">
                        <div style="font-size:10px; text-transform:uppercase; font-weight:bold; color:#047857;">Live Winstmarge</div>
                        <div class="profit-amount" id="live-profit">€ 0</div>
                    </div>

                    <button id="btn-save" class="btn btn-green" onclick="opslaan()"><i class="fa-solid fa-check"></i> Rit Opslaan</button>
                </div>
            </div>
        </div>
    </div>

    <div id="klanten" class="page-section">
        <div id="crm-list-view">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; border:none;">Relatiebeheer</h2>
                <button class="btn-blue" style="width:auto; padding:10px 20px;" onclick="nieuwKlantScherm()">+ Nieuwe Relatie</button>
            </div>
            <div class="card">
                <input type="text" id="crm-search" placeholder="Zoeken..." onkeyup="renderClientList()" style="margin-bottom:10px;">
                <table class="rit-table">
                    <thead><tr><th>Naam</th><th>Plaats</th><th>Email</th><th style="width:60px;"></th></tr></thead>
                    <tbody id="crm-table-body"></tbody>
                </table>
            </div>
        </div>
        <div id="crm-detail-view" class="hidden">
            <div class="card">
                <h3>Relatiekaart</h3>
                <div class="grid-2">
                    <div><label>Naam</label><input type="text" id="crm-naam"></div>
                    <div><label>Plaats</label><input type="text" id="crm-plaats"></div>
                </div>
                <label>Adres</label><input type="text" id="crm-adres">
                
                <h3 style="margin-top:20px;">Contactpersonen</h3>
                <div id="crm-contacts-container"></div>
                <button class="btn-link" onclick="addContactRow()">+ Contactpersoon</button>
                
                <div style="margin-top:20px; display:flex; gap:10px;">
                    <button class="btn btn-green" onclick="saveClient()">Opslaan</button>
                    <button class="btn btn-grey" onclick="terugNaarLijst()">Annuleren</button>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="offerte-modal" class="hidden modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <span><i class="fa-solid fa-file-pdf"></i> Offerte Voorbeeld</span>
            <span onclick="closeModal('offerte-modal')" style="cursor:pointer;"><i class="fa-solid fa-times"></i></span>
        </div>
        <div class="modal-body">
            <div id="pdf-content" class="pdf-container">
                </div>
        </div>
        <div class="modal-footer">
            <button class="btn-grey" style="width:auto;" onclick="closeModal('offerte-modal')">Sluiten</button>
            <button class="btn-green" style="width:auto;" onclick="generateAndMailPDF()">
                <i class="fa-solid fa-paper-plane"></i> PDF Downloaden & Mailen
            </button>
        </div>
    </div>
</div>

<script>
    // --- DATA & STATE ---
    let db = { klanten: [], ritten: [] };
    let appState = { currentYear: new Date().getFullYear(), currentMonth: new Date().getMonth(), activeRitId: null, activeClientId: null };
    let routeData = { km: 0, ritSec: 0, aanrijSec: 0, berekend: false }; // 'berekend' flag toegevoegd

    const busOpties = [ {label:'Bus 19p',prijs:0.75}, {label:'Bus 23p',prijs:0.75}, {label:'Bus 50p',prijs:1.00}, {label:'Bus 55p',prijs:1.00}, {label:'Bus 60p',prijs:1.20}, {label:'Bus 62p',prijs:1.20} ];
    const maanden = ['jan','feb','mrt','apr','mei','jun','jul','aug','sep','okt','nov','dec'];

    // TIJD TEMPLATES (V3.16 STYLE)
    const templates = {
        vv: [
            {id:'std_1', l:'Vertrek Garage', h:'08', m:'00'}, {id:'std_2', l:'Voorstaan', h:'08', m:'30'},
            {id:'std_3', l:'Vertrek Klant', h:'08', m:'45', hl:true}, {id:'std_4', l:'Aankomst Best.', h:'10', m:'00'},
            {id:'std_5', l:'Vertrek Retour', h:'16', m:'00'}, {id:'std_6', l:'Aankomst Klant', h:'17', m:'15', hl:true},
            {id:'std_7', l:'Aankomst Garage', h:'18', m:'00'}
        ],
        enkel: [
            {id:'br_1', l:'Vertrek Garage', h:'12', m:'15'}, {id:'br_2', l:'Voorstaan', h:'12', m:'45'},
            {id:'br_3', l:'Vertrek Klant', h:'13', m:'00', hl:true}, {id:'br_4', l:'Aankomst Best.', h:'13', m:'45'},
            {id:'br_5', l:'Retour Garage', h:'14', m:'30'}
        ],
        brenghaal: [ /* Gecombineerd in logica */ ],
        meerdaagse: [ /* Aparte logica */ ]
    };

    // --- INIT ---
    window.initApp = function() {
        const s = localStorage.getItem('berkhout_v319');
        if(s) db = JSON.parse(s);
        db.klanten.forEach(k => { if(!k.contactpersonen) k.contactpersonen = []; });

        renderMonthButtons();
        updateDashboard();
        
        // Bouw Bussen
        document.getElementById('bus-container').innerHTML = busOpties.map((b,i) => `
            <label class="bus-option"><input type="checkbox" class="bus-check" value="${i}" onchange="rekenPrijs()"> <span><b>${b.label}</b><br>€${b.prijs}/km</span></label>
        `).join('');

        wisselTijdLijst();
        
        // Vandaag
        const t = new Date().toISOString().split('T')[0];
        document.getElementById('rit_datum').value = t;
        document.getElementById('rit_datum_eind').value = t;
        
        initMaps();
    };

    // --- GOOGLE MAPS & TIJD LOGICA ---
    function initMaps() {
        const opts = { componentRestrictions: {country:'nl'} };
        ['route-start','route-ophaal','route-eind','route-via1','route-via2','crm-adres'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                const ac = new google.maps.places.Autocomplete(el, opts);
                ac.addListener('place_changed', () => {
                    if(id==='crm-adres') {
                        const p = ac.getPlace();
                        let stad = '';
                        p.address_components.forEach(c => { if(c.types.includes('locality')) stad = c.long_name; });
                        document.getElementById('crm-plaats').value = stad;
                    } else berekenRoute();
                });
            }
        });
    }

    function berekenRoute() {
        const s = document.getElementById('route-start').value;
        const o = document.getElementById('route-ophaal').value;
        const e = document.getElementById('route-eind').value;
        
        if(!s || !o || !e) return;

        const svc = new google.maps.DirectionsService();
        const w = [];
        if(document.getElementById('route-via1').value) w.push({location:document.getElementById('route-via1').value});
        if(document.getElementById('route-via2').value) w.push({location:document.getElementById('route-via2').value});

        svc.route({origin:s, destination:e, waypoints:w, travelMode:'DRIVING'}, (res, stat) => {
            if(stat === 'OK') {
                const l = res.routes[0].legs;
                routeData.aanrijSec = l[0].duration.value; // Garage -> Klant
                
                let ritSecs = 0; let meters = 0;
                l.forEach((leg, i) => {
                    if(i > 0) ritSecs += leg.duration.value; // Klant -> Bestemming
                    meters += leg.distance.value;
                });
                
                routeData.ritSec = ritSecs;
                
                // Dagtocht logica: 2x Afstand (Retour)
                const type = document.getElementById('rit-type').value;
                const factor = (type === 'vv') ? 2 : (type === 'brenghaal' ? 4 : 1); // BrengHaal is 4x (Garage-Klant-Best-Garage x2)
                
                routeData.km = Math.round((meters * factor) / 1000);
                routeData.berekend = true; // VLAG GEZET: Nu mag syncTijden werken

                document.getElementById('info-rit').innerText = Math.round(routeData.ritSec/60) + ' min';
                document.getElementById('info-aanrij').innerText = Math.round(routeData.aanrijSec/60) + ' min';
                document.getElementById('info-totaal').innerText = routeData.km + ' km';
                
                syncTijden(); // Nu pas syncen
            }
        });
    }

    // --- DE TIJDEN FIX (BUG OPGELOST) ---
    function syncTijden() {
        // Alleen overschrijven als er daadwerkelijk een route is berekend!
        if(!routeData.berekend) return; 

        const type = document.getElementById('rit-type').value;
        const aanrij = routeData.aanrijSec * 1000;
        const rit = routeData.ritSec * 1000;
        
        // Helper om tijd te zetten
        const set = (id, date) => {
            const h = document.getElementById('h_'+id);
            const m = document.getElementById('m_'+id);
            if(h && m) {
                h.value = date.getHours().toString().padStart(2,'0');
                m.value = date.getMinutes().toString().padStart(2,'0');
            }
        };
        const get = (id) => {
            const h = parseInt(document.getElementById('h_'+id).value);
            const m = parseInt(document.getElementById('m_'+id).value);
            return new Date(2000,0,1,h,m);
        };

        if(type === 'vv') {
            // Dagtocht: Klant Vertrek (std_3) is leidend
            const vertrekKlant = get('std_3');
            
            set('std_2', new Date(vertrekKlant - 15*60000)); // Voorstaan
            set('std_1', new Date(vertrekKlant - 15*60000 - aanrij)); // Garage
            
            const aankomst = new Date(vertrekKlant.getTime() + rit);
            set('std_4', aankomst); // Aankomst Bestemming
            
            // Retour deel laten we staan tenzij expliciet leeg? Nee, laten we zo.
            const vertrekRetour = get('std_5');
            const aankomstKlant = new Date(vertrekRetour.getTime() + rit);
            set('std_6', aankomstKlant);
            set('std_7', new Date(aankomstKlant.getTime() + aanrij));
        }
        rekenUren();
    }

    // --- UI BOUWSTEENTJES ---
    function maakTijdRegel(t) {
        let uOpts = ''; for(let i=0;i<24;i++) uOpts+=`<option value="${i.toString().padStart(2,'0')}" ${i==t.h?'selected':''}>${i.toString().padStart(2,'0')}</option>`;
        let mOpts = ''; ['00','15','30','45'].forEach(m => mOpts+=`<option value="${m}" ${m==t.m?'selected':''}>${m}</option>`);
        
        const style = t.hl ? 'border-left:3px solid var(--success); background:#f0fdf4;' : '';
        const changeFn = (t.hl && !t.id.includes('5')) ? "syncTijden(); rekenUren()" : "rekenUren()";

        return `
        <div class="time-row" style="${style}">
            <span style="font-size:12px; font-weight:600; width:100px;">${t.l}</span>
            <div class="time-select-group">
                <select id="h_${t.id}" class="select-uur" onchange="${changeFn}">${uOpts}</select> : 
                <select id="m_${t.id}" class="select-min" onchange="${changeFn}">${mOpts}</select>
            </div>
        </div>`;
    }

    function wisselTijdLijst() {
        const type = document.getElementById('rit-type').value;
        const c = document.getElementById('tijd-container');
        // Simpel gehouden voor V3.19: Dagtocht of Enkel
        const lijst = (type === 'enkel') ? templates.enkel : templates.vv;
        c.innerHTML = lijst.map(maakTijdRegel).join('');
        rekenUren();
    }

    function rekenUren() {
        // Simpele berekening: Laatste - Eerste
        const inputs = document.querySelectorAll('.select-uur');
        if(inputs.length < 2) return;
        
        const hStart = parseInt(inputs[0].value);
        const mStart = parseInt(inputs[0].nextElementSibling.value);
        const hEnd = parseInt(inputs[inputs.length-1].value);
        const mEnd = parseInt(inputs[inputs.length-1].nextElementSibling.value);
        
        let start = new Date(2000,0,1,hStart,mStart);
        let end = new Date(2000,0,1,hEnd,mEnd);
        
        let diff = (end - start) / 3600000;
        if(diff < 0) diff += 24; 
        
        document.getElementById('uren-display').innerText = diff.toFixed(2);
        rekenPrijs();
    }

    function rekenPrijs() {
        const km = routeData.km || 0;
        const uren = parseFloat(document.getElementById('uren-display').innerText) || 0;
        const extra = parseFloat(document.getElementById('kosten-extra').value) || 0;
        
        let busPrijs = 0; let bussen = 0;
        document.querySelectorAll('.bus-check:checked').forEach(c => {
            busPrijs += busOpties[c.value].prijs;
            bussen++;
        });
        document.getElementById('calc-bus-count').value = bussen;

        if(bussen === 0) {
            document.getElementById('prijs-display').innerText = '€ 0,00';
            return;
        }

        // Kostprijs (Geschat)
        const kostprijs = (km * busPrijs) + (uren * 35 * bussen) + extra;
        
        // Verkoopprijs (Kostprijs * marge + BTW)
        const marge = 1.25; // 25% marge
        let verkoopExcl = kostprijs * marge;
        // Afronden op €5,-
        verkoopExcl = Math.ceil(verkoopExcl / 5) * 5;
        
        const verkoopIncl = verkoopExcl * 1.09;
        
        document.getElementById('prijs-display').innerText = '€ ' + verkoopIncl.toLocaleString('nl-NL', {minimumFractionDigits:2});
        document.getElementById('btw-display').innerText = 'BTW (9%): € ' + (verkoopIncl - verkoopExcl).toLocaleString('nl-NL', {minimumFractionDigits:2});
        
        const winst = verkoopExcl - kostprijs;
        document.getElementById('live-profit').innerText = '€ ' + Math.round(winst);
    }

    // --- CRM ---
    function filterCalcClients() {
        const q = document.getElementById('calc-klant-zoek').value.toLowerCase();
        const res = document.getElementById('calc-klant-results');
        res.innerHTML = '';
        if(q.length < 2) { res.style.display='none'; return; }
        
        db.klanten.filter(k => k.naam.toLowerCase().includes(q)).forEach(k => {
            res.style.display = 'block';
            const div = document.createElement('div');
            div.className = 'search-item';
            div.innerHTML = `<b>${k.naam}</b> <small>${k.plaats}</small>`;
            div.onclick = () => selectKlant(k);
            res.appendChild(div);
        });
    }

    function selectKlant(k) {
        document.getElementById('calc-klant-zoek').value = k.naam;
        document.getElementById('calc-klant-id').value = k.id;
        document.getElementById('calc-klant-results').style.display='none';
        
        document.getElementById('klant-details').style.display = 'block';
        document.getElementById('klant-details').innerHTML = `<b>${k.naam}</b><br>${k.adres}<br>${k.plaats}`;
        document.getElementById('route-ophaal').value = k.adres + ', ' + k.plaats;

        const sel = document.getElementById('calc-contact');
        sel.innerHTML = k.contactpersonen.map((c,i) => `<option value="${i}">${c.naam}</option>`).join('');
        
        berekenRoute(); // Herbereken route vanaf klant adres
    }

    function nieuwKlantScherm() {
        appState.activeClientId = null;
        ['crm-naam','crm-adres','crm-plaats'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('crm-contacts-container').innerHTML = '';
        addContactRow();
        document.getElementById('crm-list-view').classList.add('hidden');
        document.getElementById('crm-detail-view').classList.remove('hidden');
    }
    
    function addContactRow(d={}) {
        const div = document.createElement('div');
        div.className = 'contact-row'; // Hergebruik CSS V3.16
        div.style.cssText = "display:grid; grid-template-columns:1fr 1fr 40px; gap:5px; margin-bottom:5px;";
        div.innerHTML = `<input placeholder="Naam" value="${d.naam||''}"><input placeholder="Email" value="${d.email||''}"><button onclick="this.parentElement.remove()">x</button>`;
        document.getElementById('crm-contacts-container').appendChild(div);
    }

    function saveClient() {
        const naam = document.getElementById('crm-naam').value;
        const contacts = [];
        document.querySelectorAll('#crm-contacts-container div').forEach(r => {
            const i = r.querySelectorAll('input');
            if(i[0].value) contacts.push({naam:i[0].value, email:i[1].value});
        });
        
        const c = { id: appState.activeClientId || Date.now(), naam, adres: document.getElementById('crm-adres').value, plaats: document.getElementById('crm-plaats').value, contactpersonen: contacts };
        
        if(appState.activeClientId) {
            const idx = db.klanten.findIndex(x => x.id == appState.activeClientId);
            db.klanten[idx] = c;
        } else db.klanten.push(c);
        
        localStorage.setItem('berkhout_v319', JSON.stringify(db));
        renderClientList();
        terugNaarLijst();
    }
    
    function renderClientList() {
        const q = document.getElementById('crm-search').value.toLowerCase();
        const b = document.getElementById('crm-table-body');
        b.innerHTML = '';
        db.klanten.filter(k => k.naam.toLowerCase().includes(q)).forEach(k => {
            b.innerHTML += `<tr><td><b>${k.naam}</b></td><td>${k.plaats}</td><td>${k.contactpersonen[0]?.email||'-'}</td><td><button class="btn-icon" onclick="startOfferte(${k.id})"><i class="fa-solid fa-arrow-right"></i></button></td></tr>`;
        });
    }
    
    function startOfferte(id) { 
        resetForm(); 
        nav('calculatie'); 
        selectKlant(db.klanten.find(k=>k.id==id)); 
    }
    
    function terugNaarLijst() {
        document.getElementById('crm-list-view').classList.remove('hidden');
        document.getElementById('crm-detail-view').classList.add('hidden');
    }

    // --- OPSLAAN & DASHBOARD ---
    function opslaan() {
        const datum = document.getElementById('rit_datum').value;
        const klantId = document.getElementById('calc-klant-id').value;
        if(!klantId) return alert("Selecteer eerst een klant");
        
        const tijdData = {};
        document.querySelectorAll('.select-uur').forEach(el => {
            const id = el.id.replace('h_','');
            tijdData[id] = el.value + ':' + el.nextElementSibling.value;
        });

        const rit = {
            id: appState.activeRitId || Date.now(),
            datum,
            klantId,
            dest: document.getElementById('route-eind').value,
            prijs: document.getElementById('prijs-display').innerText,
            status: (appState.activeRitId ? db.ritten.find(r=>r.id==appState.activeRitId).status : {offerte:false, bevestiging:false, opdracht:false, factuur:false}),
            details: {
                datum_eind: document.getElementById('rit_datum_eind').value,
                pax: document.getElementById('calc-pax').value,
                contactIdx: document.getElementById('calc-contact').value,
                route: {
                    start: document.getElementById('route-start').value,
                    ophaal: document.getElementById('route-ophaal').value,
                    eind: document.getElementById('route-eind').value
                },
                tijden: tijdData,
                bussen: Array.from(document.querySelectorAll('.bus-check:checked')).map(c=>c.value)
            }
        };

        if(appState.activeRitId) {
            const idx = db.ritten.findIndex(r => r.id == appState.activeRitId);
            db.ritten[idx] = rit;
        } else db.ritten.unshift(rit);

        localStorage.setItem('berkhout_v319', JSON.stringify(db));
        resetForm();
        nav('dashboard');
        updateDashboard();
    }

    function updateDashboard() {
        const b = document.getElementById('rit-tabel-body');
        b.innerHTML = '';
        const fil = db.ritten.filter(r => {
            const d = new Date(r.datum);
            return d.getFullYear() === appState.currentYear && (appState.currentMonth === -1 || d.getMonth() === appState.currentMonth);
        }).sort((x,y) => new Date(x.datum) - new Date(y.datum));

        if(fil.length === 0) { document.getElementById('empty-state').style.display='block'; return; }
        document.getElementById('empty-state').style.display='none';

        fil.forEach(r => {
            const k = db.klanten.find(x=>x.id==r.klantId);
            const d = new Date(r.datum).toLocaleDateString('nl-NL', {day:'2-digit', month:'2-digit'});
            
            const ico = (type) => r.status[type] ? 'done' : '';
            
            b.innerHTML += `
            <tr>
                <td><button class="btn-icon" onclick="laadRit(${r.id})"><i class="fa-solid fa-pen"></i></button></td>
                <td><b>${d}</b></td>
                <td>
                    <div style="font-weight:bold; color:var(--primary);">${k?k.naam:'?'}</div>
                    <div style="font-size:11px; color:#64748b;">${r.dest}</div>
                </td>
                <td style="text-align:right; font-weight:bold;">${r.prijs}</td>
                
                <td class="status-cell" onclick="openOfferteModal(${r.id})"><i class="status-icon fa-solid fa-circle-check ${ico('offerte')}"></i></td>
                <td class="status-cell" onclick="toggleStatus(${r.id}, 'bevestiging')"><i class="status-icon fa-solid fa-circle-check ${ico('bevestiging')}"></i></td>
                <td class="status-cell" onclick="toggleStatus(${r.id}, 'opdracht')"><i class="status-icon fa-solid fa-bus ${ico('opdracht')}"></i></td>
                <td class="status-cell" onclick="toggleStatus(${r.id}, 'factuur')"><i class="status-icon fa-solid fa-file-invoice-dollar ${ico('factuur')}"></i></td>
            </tr>`;
        });
    }

    function laadRit(id) {
        const r = db.ritten.find(x => x.id === id);
        appState.activeRitId = id;
        nav('calculatie');
        document.getElementById('calc-title').innerText = "Rit Bewerken";
        
        document.getElementById('rit_datum').value = r.datum;
        document.getElementById('rit_datum_eind').value = r.details.datum_eind;
        selectKlant(db.klanten.find(k=>k.id==r.klantId));
        document.getElementById('calc-pax').value = r.details.pax;
        document.getElementById('route-eind').value = r.details.route.eind;
        
        // Tijden herstellen
        setTimeout(() => {
            for(const [k,v] of Object.entries(r.details.tijden)) {
                const parts = v.split(':');
                if(document.getElementById('h_'+k)) {
                    document.getElementById('h_'+k).value = parts[0];
                    document.getElementById('m_'+k).value = parts[1];
                }
            }
            rekenUren();
        }, 500); // Wacht even op DOM opbouw
    }

    function toggleStatus(id, field) {
        const r = db.ritten.find(x => x.id === id);
        r.status[field] = !r.status[field];
        localStorage.setItem('berkhout_v319', JSON.stringify(db));
        updateDashboard();
    }

    // --- PDF GENERATOR (EXACTE KOPIE) ---
    function openOfferteModal(id) {
        appState.activeRitId = id;
        const r = db.ritten.find(x => x.id === id);
        const k = db.klanten.find(x => x.id == r.klantId);
        
        // Data formatten
        const today = new Date().toLocaleDateString('nl-NL');
        const dStart = new Date(r.datum).toLocaleDateString('nl-NL');
        const dEnd = new Date(r.details.datum_eind).toLocaleDateString('nl-NL');
        
        // Prijzen
        const pIncl = parseFloat(r.prijs.replace(/[^0-9,.-]+/g,"").replace(',','.'));
        const pExcl = pIncl / 1.09;
        const pBtw = pIncl - pExcl;

        // Contact
        let attn = "T.a.v. de heer/mevrouw";
        if(r.details.contactIdx && k.contactpersonen[r.details.contactIdx]) {
            attn = "T.a.v. " + k.contactpersonen[r.details.contactIdx].naam;
        }

        // Tijden ophalen (met fallback)
        const gt = (key) => r.details.tijden[key] ? r.details.tijden[key].replace(':',':') + ' uur' : '--:--';

        // HTML Bouwen
        const html = `
            <div class="pdf-header-row">
                <div>
                    <div class="pdf-logo">Berkhout Busreizen</div>
                    <div class="pdf-sender">
                        Industrieweg 95A<br>
                        7202 CA Zutphen<br>
                        0575-525345<br>
                        info@berkhoutreizen.nl<br>
                        www.berkhoutreizen.nl
                    </div>
                </div>
                <div class="pdf-meta">
                    <div class="pdf-slogan">Snel, veilig & comfortabel</div>
                    Zutphen, ${today}<br>
                    <strong>Betreft:</strong> uw offerte (Ref: ${r.id})
                </div>
            </div>

            <div class="pdf-receiver">
                ${k.naam}<br>
                ${attn}<br>
                ${k.adres}<br>
                ${k.plaats}
            </div>

            <div style="margin-top:20px;">
                Geachte relatie,<br><br>
                Wij danken u voor uw aanvraag en hebben hierbij het genoegen u een vrijblijvende offerte, op basis van beschikbaarheid, te doen toekomen.
                Hieronder volgt het programma zoals is besproken en de kosten hiervoor.
            </div>

            <div class="pdf-subject">Programma</div>

            <table class="pdf-grid-table">
                <tr><td class="pdf-label-col">Vertrekdatum</td><td class="pdf-val-col">${dStart}</td></tr>
                <tr><td class="pdf-label-col">Einddatum</td><td class="pdf-val-col">${dEnd}</td></tr>
                <tr><td class="pdf-label-col">Aantal touringcars</td><td class="pdf-val-col">${r.details.bussen.length}</td></tr>
                <tr><td class="pdf-label-col">Aantal passagiers</td><td class="pdf-val-col">${r.details.pax}</td></tr>
            </table>

            <div style="height:15px;"></div>

            <table class="pdf-grid-table">
                <tr><td class="pdf-label-col">Vertrekadres</td><td class="pdf-val-col">${r.details.route.start}</td></tr>
                <tr><td class="pdf-label-col">Vertrekplaats</td><td class="pdf-val-col">Zutphen</td></tr>
                <tr><td class="pdf-label-col">Voorstaan</td><td class="pdf-val-col">${gt('std_2')}</td></tr>
                <tr><td class="pdf-label-col">Vertrektijd</td><td class="pdf-val-col">${gt('std_1')}</td></tr>
                <tr><td colspan="2" style="height:5px;"></td></tr>
                <tr><td class="pdf-label-col">Bestemming</td><td class="pdf-val-col">${r.dest}</td></tr>
                <tr><td class="pdf-label-col">Adres</td><td class="pdf-val-col">${r.details.route.eind}</td></tr>
                <tr><td class="pdf-label-col">Aankomsttijd</td><td class="pdf-val-col">${gt('std_4')}</td></tr>
            </table>

            <div class="pdf-subject">Financieel Overzicht</div>

            <table class="pdf-money-table">
                <tr><th>Beschrijving</th><th>Bedrag</th></tr>
                <tr>
                    <td>Vervoerskosten (excl. BTW)</td>
                    <td>€ ${pExcl.toLocaleString('nl-NL',{minimumFractionDigits:2})}</td>
                </tr>
                 <tr>
                    <td>BTW (9%)</td>
                    <td>€ ${pBtw.toLocaleString('nl-NL',{minimumFractionDigits:2})}</td>
                </tr>
                <tr>
                    <td class="pdf-money-total">Totaalprijs incl. BTW:</td>
                    <td class="pdf-money-total">€ ${pIncl.toLocaleString('nl-NL',{minimumFractionDigits:2})}</td>
                </tr>
            </table>

            <div class="pdf-footer">
                Indien van het bovenstaande programma wordt afgeweken, kan er een prijsaanpassing volgen.
                De aanbieding is exclusief eventuele parkeer-, tol- en/of verblijfskosten. Wij behouden ons het recht voor onze reissommen te wijzigen, indien daartoe aanleiding bestaat door prijs en/of brandstofverhogingen door derden.<br><br>
                Wij vertrouwen erop u met deze offerte een passende aanbieding te hebben gedaan en zien uw reactie gaarne tegemoet.<br><br>
                Met vriendelijke groeten,<br>
                <strong>Berkhout Reizen</strong><br>
                Fred Stravers
            </div>
        `;

        document.getElementById('pdf-content').innerHTML = html;
        document.getElementById('offerte-modal').classList.remove('hidden');
    }

    function generateAndMailPDF() {
        const el = document.getElementById('pdf-content');
        const opt = {
            margin: 0,
            filename: `Offerte_Berkhout.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 }, // Hoge kwaliteit
            jsPDF: { unit: 'px', format: [794, 1123], orientation: 'portrait' } // Exacte pixels
        };

        html2pdf().set(opt).from(el).save().then(() => {
            const r = db.ritten.find(x => x.id == appState.activeRitId);
            r.status.offerte = true;
            localStorage.setItem('berkhout_v319', JSON.stringify(db));
            updateDashboard();
            
            // Mail
            const k = db.klanten.find(x => x.id == r.klantId);
            const email = (k.contactpersonen[0]) ? k.contactpersonen[0].email : '';
            window.location.href = `mailto:${email}?subject=Offerte Berkhout&body=Geachte, zie bijlage.`;
            
            closeModal('offerte-modal');
        });
    }

    // Navigatie
    function nav(id) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    function resetForm() {
        appState.activeRitId = null;
        document.getElementById('calc-title').innerText = "Nieuwe Aanvraag";
        document.querySelectorAll('input:not(#route-start)').forEach(i => i.value = '');
        routeData = {km:0, ritSec:0, aanrijSec:0, berekend:false}; // Reset route data
        document.getElementById('info-totaal').innerText = "0 km";
    }
    function changeYear(d){appState.currentYear+=d; document.getElementById('display-year').innerText=appState.currentYear; updateDashboard();}
    function renderMonthButtons(){const c=document.getElementById('month-buttons'); c.innerHTML=['Alle',...maanden].map((m,i)=>`<button onclick="appState.currentMonth=${i-1};renderMonthButtons();updateDashboard()" style="padding:5px 10px; margin:2px; border:1px solid #ccc; background:${appState.currentMonth===i-1?'var(--primary)':'#fff'}; color:${appState.currentMonth===i-1?'#fff':'#333'}">${m}</button>`).join('');}
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
</script>
</body>
</html>
